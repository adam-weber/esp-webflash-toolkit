<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 NVS Tools - Learn</title>
    <link rel="stylesheet" href="shared-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <style>
        body {
            display: flex;
            margin: 0;
            padding-top: 60px;
            padding-left: 0;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 60px;
            width: 260px;
            height: calc(100vh - 60px);
            overflow-y: auto;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            padding: 32px 0;
            z-index: 100;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .sidebar-link {
            display: block;
            padding: 8px 48px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .sidebar-link:hover {
            background: var(--bg-tertiary);
            text-decoration: none;
        }

        .sidebar-section {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 16px 48px 8px;
            margin-top: 16px;
            transition: color 0.3s ease;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            margin-left: calc(260px + (100vw - 260px - 900px) / 2);
            padding: 48px 48px 120px;
        }

        @media (max-width: 1160px) {
            .container {
                margin-left: 260px;
                margin-right: 48px;
            }
        }

        .hero {
            margin-bottom: 64px;
        }

        .hero h1 {
            font-size: 40px;
            font-weight: 600;
            letter-spacing: -0.005em;
            margin-bottom: 12px;
        }

        .hero .subtitle {
            font-size: 19px;
            color: #6e6e73;
            font-weight: 400;
            line-height: 1.4;
            letter-spacing: 0.004em;
        }

        .lesson {
            margin-bottom: 80px;
            scroll-margin-top: 80px;
        }

        .lesson-tag {
            display: inline-block;
            font-size: 11px;
            color: #0071e3;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
        }

        h2 {
            font-size: 32px;
            font-weight: 600;
            letter-spacing: -0.003em;
            margin-bottom: 12px;
        }

        .lesson-intro {
            font-size: 17px;
            line-height: 1.47;
            font-weight: 400;
            letter-spacing: -0.022em;
            color: var(--text-secondary);
            margin-bottom: 32px;
            transition: color 0.3s ease;
        }

        h3 {
            font-size: 21px;
            font-weight: 600;
            letter-spacing: 0.004em;
            color: var(--text-primary);
            margin: 40px 0 16px;
            text-transform: none;
            transition: color 0.3s ease;
        }

        p {
            font-size: 15px;
            line-height: 1.5;
            font-weight: 400;
            letter-spacing: -0.016em;
            margin-bottom: 16px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .callout {
            background: var(--bg-tertiary);
            border-radius: 18px;
            padding: 32px;
            margin: 40px 0;
            transition: background-color 0.3s ease;
        }

        .callout-title {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.022em;
            margin-bottom: 12px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .callout-body {
            font-size: 17px;
            line-height: 1.47059;
            font-weight: 400;
            letter-spacing: -0.022em;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .code-block-wrapper {
            position: relative;
            margin: 32px 0;
            background: #1e1e1e;
            border-radius: 12px;
        }

        .code-block-header {
            position: relative;
            height: 40px;
            display: flex;
            align-items: center;
            padding: 0 24px;
            background: transparent;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.15s ease;
        }

        .code-block-wrapper:hover .code-block-header {
            background: rgba(255, 255, 255, 0.03);
        }

        body.dark-mode .code-block-wrapper:hover .code-block-header {
            background: rgba(255, 255, 255, 0.05);
        }

        .code-block-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .code-block-toggle svg {
            width: 12px;
            height: 12px;
            stroke: rgba(255, 255, 255, 0.5);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .code-block-wrapper:hover .code-block-toggle svg {
            stroke: rgba(255, 255, 255, 0.7);
        }

        .code-block-wrapper.collapsed .code-block-toggle svg {
            transform: rotate(-90deg);
        }

        .code-block-label {
            font-size: 11px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.35);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            transition: color 0.15s ease;
            flex-shrink: 0;
        }

        .code-block-wrapper:hover .code-block-label {
            color: rgba(255, 255, 255, 0.5);
        }

        .code-block-content {
            max-height: 10000px;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.2s ease;
            opacity: 1;
        }

        .code-block-wrapper.collapsed .code-block-content {
            max-height: 0;
            opacity: 0;
        }

        .code-block-wrapper pre[class*="language-"] {
            margin: 0 !important;
            border-radius: 0 !important;
            background: transparent !important;
            padding-top: 0 !important;
        }

        pre[class*="language-"] {
            background: #1e1e1e !important;
            border-radius: 12px;
            padding: 24px !important;
            margin: 32px 0 !important;
            font-size: 14px;
            line-height: 1.6;
        }

        :not(pre) > code {
            background: var(--code-inline-bg);
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        ul, ol {
            margin: 16px 0;
            padding-left: 24px;
        }

        li {
            font-size: 15px;
            line-height: 1.5;
            font-weight: 400;
            letter-spacing: -0.016em;
            margin-bottom: 8px;
        }

        .visual-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color-light);
            border-radius: 18px;
            padding: 40px;
            margin: 48px 0;
            transition: all 0.3s ease;
        }

        .visual-title {
            font-size: 21px;
            font-weight: 600;
            letter-spacing: 0.011em;
            text-align: center;
            margin-bottom: 32px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .step-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto 1fr;
            gap: 24px;
            align-items: center;
        }

        .step {
            text-align: center;
        }

        .step-num {
            width: 56px;
            height: 56px;
            background: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 24px;
            font-weight: 600;
            color: #0071e3;
            transition: background-color 0.3s ease;
        }

        .step-label {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .step-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
            transition: color 0.3s ease;
        }

        .arrow {
            font-size: 28px;
            color: #0071e3;
        }

        /* Generated Interface Panel Styles */
        .interface-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color-light);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
        }

        body.dark-mode .interface-panel {
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .panel-number {
            width: 32px;
            height: 32px;
            background: var(--text-primary);
            color: var(--bg-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .panel-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .field-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: color 0.3s ease;
        }

        .field-value {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color-light);
            border-radius: 8px;
            font-size: 15px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .status-connected {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #e6f7ed;
            border: 1px solid #34a853;
            border-radius: 8px;
        }

        body.dark-mode .status-connected {
            background: rgba(52, 168, 83, 0.15);
            border-color: rgba(52, 168, 83, 0.4);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #34a853;
            border-radius: 50%;
        }

        .status-text {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .progress-bar-bg {
            background: var(--bg-tertiary);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        .progress-bar-fill {
            background: #0071e3;
            height: 100%;
            width: 65%;
        }

        .progress-text {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 6px;
            transition: color 0.3s ease;
        }

        .button-primary {
            flex: 1;
            padding: 12px;
            background: #0071e3;
            color: white;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
        }

        .button-secondary {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-item {
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-item:hover {
            background: var(--border-color);
        }

        .action-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .action-description {
            font-size: 12px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .button-group {
            display: flex;
            gap: 8px;
        }

        .features-box {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            transition: background-color 0.3s ease;
        }

        .features-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .features-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            font-size: 13px;
        }

        .feature-item {
            display: flex;
            align-items: start;
            gap: 8px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .feature-checkmark {
            color: #34a853;
            font-size: 16px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 40px 0;
        }

        .card {
            background: var(--bg-tertiary);
            border-radius: 18px;
            padding: 24px;
            transition: background-color 0.3s ease;
        }

        .card h4 {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .card p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0;
            transition: color 0.3s ease;
        }

        a {
            color: #0071e3;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Hex Visualizer */
        .hex-visualizer {
            margin: 32px -100px;
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid var(--border-color-light);
            background: var(--bg-secondary);
            transition: all 0.3s ease;
            max-width: none;
        }

        .hex-tabs {
            display: flex;
            gap: 0;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color-light);
            padding: 8px;
        }

        .hex-tab {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .hex-tab:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .hex-tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        body.dark-mode .hex-tab.active {
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .hex-viewer {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 0;
        }

        .hex-content {
            display: flex;
            padding: 24px;
            background: var(--bg-secondary);
        }

        .hex-offsets {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-right: 16px;
            padding-right: 16px;
            border-right: 1px solid var(--border-color-light);
        }

        .offset-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .offset {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-tertiary);
            font-family: 'SF Mono', Monaco, monospace;
            height: 28px;
            display: flex;
            align-items: center;
            transition: color 0.2s ease;
        }

        .hex-bytes {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
            flex: 1;
        }

        .hex-byte {
            width: 44px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: filter 0.15s ease, outline 0.15s ease;
            color: var(--text-primary);
            background: var(--bg-tertiary);
            outline: 2px solid transparent;
            outline-offset: -2px;
        }

        .hex-byte:hover {
            filter: brightness(1.1);
            outline-color: rgba(0, 113, 227, 0.4);
        }

        body.dark-mode .hex-byte:hover {
            filter: brightness(1.3);
            outline-color: rgba(0, 113, 227, 0.6);
        }

        .hex-byte.active {
            filter: brightness(1.1);
            outline-color: rgba(0, 113, 227, 0.6);
        }

        body.dark-mode .hex-byte.active {
            filter: brightness(1.3);
            outline-color: rgba(0, 113, 227, 0.8);
        }

        /* Color coding for different field types */
        .hex-byte.field-state { background: #e3f2fd; color: #1565c0; }
        .hex-byte.field-seq { background: #f3e5f5; color: #6a1b9a; }
        .hex-byte.field-version { background: #fff3e0; color: #e65100; }
        .hex-byte.field-reserved { background: var(--bg-tertiary); color: var(--text-tertiary); opacity: 0.5; }
        .hex-byte.field-crc { background: #fce4ec; color: #c2185b; }
        .hex-byte.field-namespace { background: #e8f5e9; color: #2e7d32; }
        .hex-byte.field-type { background: #fff9c4; color: #f57f17; }
        .hex-byte.field-span { background: #ede7f6; color: #5e35b1; }
        .hex-byte.field-key { background: #e1f5fe; color: #0277bd; }
        .hex-byte.field-data { background: #ffebee; color: #c62828; }

        body.dark-mode .hex-byte.field-state { background: rgba(33, 150, 243, 0.2); color: #90caf9; }
        body.dark-mode .hex-byte.field-seq { background: rgba(156, 39, 176, 0.2); color: #ce93d8; }
        body.dark-mode .hex-byte.field-version { background: rgba(255, 152, 0, 0.2); color: #ffb74d; }
        body.dark-mode .hex-byte.field-crc { background: rgba(233, 30, 99, 0.2); color: #f48fb1; }
        body.dark-mode .hex-byte.field-namespace { background: rgba(76, 175, 80, 0.2); color: #a5d6a7; }
        body.dark-mode .hex-byte.field-type { background: rgba(255, 235, 59, 0.2); color: #fff59d; }
        body.dark-mode .hex-byte.field-span { background: rgba(103, 58, 183, 0.2); color: #b39ddb; }
        body.dark-mode .hex-byte.field-key { background: rgba(3, 169, 244, 0.2); color: #81d4fa; }
        body.dark-mode .hex-byte.field-data { background: rgba(244, 67, 54, 0.2); color: #ef9a9a; }

        .hex-info {
            background: var(--bg-tertiary);
            border-left: 1px solid var(--border-color-light);
            padding: 24px;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }

        .hex-info-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: var(--text-tertiary);
            text-align: center;
        }

        .hex-info-empty svg {
            opacity: 0.3;
        }

        .hex-info-empty p {
            font-size: 13px;
            margin: 0;
        }

        .hex-info-content {
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hex-info-field {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 6px;
        }

        .hex-info-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .hex-info-desc {
            font-size: 13px;
            line-height: 1.5;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .hex-info-range {
            display: inline-block;
            padding: 4px 8px;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-size: 12px;
            font-family: 'SF Mono', Monaco, monospace;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .hex-info-bytes {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color-light);
        }

        .hex-info-bytes-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .hex-info-bytes-value {
            font-size: 13px;
            font-family: 'SF Mono', Monaco, monospace;
            color: var(--text-primary);
            word-break: break-all;
            line-height: 1.6;
        }

        /* Binary Format Visualizations */
        .page-architecture {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            align-items: start;
        }

        .page-diagram {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .page-header-viz, .page-entry-viz, .page-unused-viz {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 8px 12px;
            border-left: 3px solid;
            transition: all 0.3s ease;
        }

        .page-header-viz {
            border-left-color: #2196F3;
            background: rgba(33, 150, 243, 0.08);
        }

        .page-entry-viz {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.08);
        }

        .page-unused-viz {
            border-left-color: var(--border-color);
            opacity: 0.5;
        }

        .viz-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .viz-size {
            font-size: 11px;
            font-family: 'SF Mono', Monaco, monospace;
            color: var(--text-secondary);
        }

        .viz-range {
            font-size: 10px;
            font-family: 'SF Mono', Monaco, monospace;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        .page-entries-container {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .page-entries-ellipsis {
            padding: 8px 12px;
            text-align: center;
            color: var(--text-tertiary);
        }

        .ellipsis-dots {
            font-size: 18px;
            line-height: 1;
        }

        .ellipsis-text {
            font-size: 11px;
            margin-top: 2px;
        }

        .page-calculation {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            position: sticky;
            top: 100px;
        }

        .calc-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .calc-step {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .calc-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .calc-value {
            font-size: 12px;
            font-weight: 600;
            font-family: 'SF Mono', Monaco, monospace;
            color: var(--text-primary);
        }

        .calc-divider {
            height: 1px;
            background: var(--border-color);
            margin: 6px 0;
        }

        .calc-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: rgba(0, 113, 227, 0.1);
            border-radius: 6px;
            margin-top: 4px;
        }

        .calc-result .calc-value {
            color: #0071e3;
        }

        .calc-note {
            font-size: 10px;
            color: var(--text-tertiary);
            margin-top: 6px;
            font-style: italic;
            text-align: center;
        }

        /* Field Breakdown */
        .field-breakdown {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .breakdown-row {
            display: grid;
            grid-template-columns: 45px 1fr;
            gap: 8px;
            align-items: center;
        }

        .breakdown-offset {
            font-size: 10px;
            font-weight: 600;
            font-family: 'SF Mono', Monaco, monospace;
            color: var(--text-tertiary);
            text-align: right;
        }

        .breakdown-field {
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .breakdown-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .breakdown-size {
            font-size: 10px;
            font-family: 'SF Mono', Monaco, monospace;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        .breakdown-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Namespace Flow */
        .namespace-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .flow-step {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .flow-number {
            width: 24px;
            height: 24px;
            background: #0071e3;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }

        .flow-content {
            flex: 1;
        }

        .flow-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .flow-detail {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .flow-arrow {
            font-size: 18px;
            color: var(--text-tertiary);
        }

        .namespace-example {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .example-section {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
        }

        .example-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .example-entry {
            display: flex;
            align-items: center;
            gap: 3px;
            margin-bottom: 8px;
        }

        .entry-byte {
            padding: 4px 7px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px;
            font-weight: 500;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .entry-text {
            padding: 4px 8px;
            background: rgba(3, 169, 244, 0.2);
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px;
            color: var(--text-primary);
        }

        .example-annotation {
            font-size: 10px;
            color: var(--text-secondary);
            padding: 6px 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .anno-label {
            font-weight: 600;
            color: var(--text-tertiary);
        }

        /* Concrete Example */
        .concrete-example {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .example-flow {
            display: grid;
            grid-template-columns: 1fr auto 1.2fr auto 1.5fr;
            gap: 12px;
            align-items: center;
        }

        .flow-stage {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .stage-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            text-align: center;
        }

        .stage-box {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--border-color);
        }

        .stage-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .stage-code {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px;
            color: var(--text-primary);
            margin: 0;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color-light);
        }

        .analysis-item:last-child {
            border-bottom: none;
        }

        .analysis-key {
            font-size: 10px;
            color: var(--text-tertiary);
            font-weight: 600;
        }

        .analysis-value {
            font-size: 11px;
            font-family: 'SF Mono', Monaco, monospace;
            color: var(--text-primary);
        }

        .flow-arrow-big {
            font-size: 24px;
            color: var(--text-tertiary);
            text-align: center;
        }

        .binary-grid {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .binary-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .binary-label {
            font-size: 10px;
            font-family: 'SF Mono', Monaco, monospace;
            color: var(--text-tertiary);
            min-width: 65px;
            font-weight: 600;
        }

        .binary-bytes {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
        }

        .bin-byte {
            padding: 3px 6px;
            border-radius: 3px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 10px;
            font-weight: 500;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .endian-explanation {
            background: rgba(0, 113, 227, 0.08);
            border: 1px solid rgba(0, 113, 227, 0.2);
            border-radius: 8px;
            padding: 12px;
        }

        .endian-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .endian-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .endian-step {
            padding: 6px 10px;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .endian-arrow {
            color: #0071e3;
            font-size: 14px;
            font-weight: 600;
        }

        .endian-note {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: center;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 80px 24px;
            }

            .hero h1 {
                font-size: 40px;
            }

            .hero .subtitle {
                font-size: 21px;
            }

            h2 {
                font-size: 32px;
            }

            h3 {
                font-size: 24px;
            }

            .step-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .arrow {
                transform: rotate(90deg);
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        /* Component Architecture - remove wrapper spacing and headers */
        .tab-content .code-block-wrapper {
            margin: 0 !important;
            background: transparent !important;
            border-radius: 0 !important;
        }

        .tab-content .code-block-header {
            height: 32px !important;
            padding: 0 16px !important;
            background: rgba(255,255,255,0.03) !important;
        }

        .tab-content .code-block-content {
            border-radius: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        .tab-content .tab-pane {
            padding: 0 !important;
            margin: 0 !important;
        }

        .tab-content pre {
            margin: 0 !important;
        }

        .tab-content pre code {
            display: block;
            padding: 16px;
            margin: 0 !important;
        }

        /* Line numbers styling for Component Architecture */
        .tab-content pre.line-numbers {
            padding-left: 0;
            counter-reset: linenumber;
        }

        .tab-content pre.line-numbers > code {
            padding-left: calc(3.8em + 16px) !important;
        }

        .tab-content .line-numbers-rows {
            position: absolute;
            pointer-events: none;
            top: 0;
            left: 0;
            width: 3em;
            padding: 16px 0;
            user-select: none;
            background: rgba(0,0,0,0.2);
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .tab-content .line-numbers-rows > span {
            display: block;
            counter-increment: linenumber;
            text-align: right;
            padding-right: 0.8em;
            color: rgba(255,255,255,0.3);
            font-size: 12px;
        }

        .tab-content .line-numbers-rows > span:before {
            content: counter(linenumber);
        }

        /* Tab navigation refinements - Apple style */
        .tab-buttons .tab-btn {
            font-size: 13px;
            font-weight: 500;
            -webkit-font-smoothing: antialiased;
        }

        .tab-buttons .tab-btn:hover {
            background: rgba(0,0,0,0.04) !important;
            border-color: rgba(0,0,0,0.1) !important;
        }

        body.dark-mode .tab-buttons .tab-btn:hover {
            background: rgba(255,255,255,0.06) !important;
            border-color: rgba(255,255,255,0.12) !important;
        }

        .tab-buttons .tab-btn.active {
            box-shadow: 0 1px 3px rgba(0,122,255,0.12),
                        0 1px 2px rgba(0,122,255,0.08),
                        inset 0 1px 0 rgba(255,255,255,0.4) !important;
        }

        /* Quickstart callout link hover effect */
        .quickstart-link:hover {
            background: rgba(0,122,255,0.12) !important;
            border-color: rgba(0,122,255,0.3) !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,122,255,0.15);
        }

    </style>
</head>
<body>
    <div id="navbar-container"></div>

    <nav class="sidebar">
        <div class="sidebar-section">Overview</div>
        <a href="#quickstart" class="sidebar-link">Quickstart</a>
        <a href="#why" class="sidebar-link">Why This Exists</a>

        <div class="sidebar-section">Usage</div>
        <a href="#javascript" class="sidebar-link">JavaScript API</a>
        <a href="#router" class="sidebar-link">Firmware Router</a>
        <a href="#flash" class="sidebar-link">Flash to Device</a>
        <a href="#read" class="sidebar-link">Read from Firmware</a>
        <a href="#template" class="sidebar-link">Web Flasher Scaffold</a>
        <a href="#examples" class="sidebar-link">Code Examples</a>

        <div class="sidebar-section">Internals</div>
        <a href="#format" class="sidebar-link">Binary Format (V1)</a>
        <a href="#details" class="sidebar-link">Edge Cases</a>

        <div class="sidebar-section">Resources</div>
        <a href="#links" class="sidebar-link">Links</a>
    </nav>

    <div class="container">
        <div class="hero">
            <h1>ESP32 Web-Based Configuration Tools</h1>
            <p class="subtitle">Storage configuration (NVS), firmware routing patterns, and scaffold frameworks for browser-based ESP32 provisioning workflows</p>
        </div>

        <p>
            This library adds application-layer capabilities to esptool-js (which handles protocol-level byte flashing via Web Serial), like: client-side NVS partition generation, chip-detection-based firmware routing, and configurable UI scaffolds. Components integrate independently with esptool-js and are composable based on implementation requirements.
        </p>

        <a href="#quickstart" class="quickstart-link" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; background: rgba(0,122,255,0.08); border: 1px solid rgba(0,122,255,0.2); border-radius: 10px; text-decoration: none; color: #007AFF; font-size: 14px; font-weight: 500; margin: 24px 0; transition: all 0.2s ease;">
            <span>Jump to Quickstart where you'll generate and flash an ESP32 config in 30 seconds</span>
            <span style="font-size: 16px;">↗</span>
        </a>

        <!-- Why -->
        <div id="why" class="lesson">

            <h2 style="margin-top: 56px;">Use Cases</h2>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 32px 0;">
                <div style="padding: 20px 24px; background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.08); border-radius: 12px;">
                    <h4 style="margin-top: 0;">Factory Programming</h4>
                    <p style="margin-bottom: 0;">Scan barcodes for device IDs, input calibration values, flash via web interface. Eliminates Python toolchains and CSV errors. ~30 seconds per unit.</p>
                </div>
                <div style="padding: 20px 24px; background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.08); border-radius: 12px;">
                    <h4 style="margin-top: 0;">Configuration Updates</h4>
                    <p style="margin-bottom: 0;">Read NVS from device, modify parameters, regenerate partition, flash. Update settings without reflashing firmware.</p>
                </div>
                <div style="padding: 20px 24px; background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.08); border-radius: 12px;">
                    <h4 style="margin-top: 0;">End-User Provisioning</h4>
                    <p style="margin-bottom: 0;">Users input WiFi credentials through browser, connect device via USB, complete provisioning. Credentials stay client-side.</p>
                </div>
            </div>

            <h2 style="margin-top: 56px;">Demos</h2>


            <!-- Firmware Router Preview Card -->
            <div style="background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.08); border-radius: 12px; overflow: hidden; margin: 0 0 32px 0;">
                <!-- Preview Window -->
                <div style="background: var(--bg-secondary); border-bottom: 1px solid rgba(0,0,0,0.08); padding: 32px 40px; overflow: hidden;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 32px; transform: scale(1); transform-origin: center;">
                        <!-- Device Detection -->
                        <div style="flex: 0 0 auto; text-align: center;">
                            <div style="width: 72px; height: 72px; margin: 0 auto 10px; background: var(--bg-tertiary); border: 1px solid rgba(0,0,0,0.06); border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
                                <div style="font-size: 11px; font-weight: 600; color: var(--text-secondary); letter-spacing: 0.02em;">C3</div>
                            </div>
                            <div style="font-size: 13px; font-weight: 600; color: var(--text-primary); letter-spacing: -0.01em;">ESP32-C3</div>
                            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px; text-transform: uppercase; letter-spacing: 0.03em; font-weight: 500;">Detected</div>
                        </div>

                        <!-- Arrow -->
                        <div style="flex: 0 0 auto; color: var(--text-tertiary); font-size: 24px; margin: 0 4px; font-weight: 400;">→</div>

                        <!-- Routing Logic -->
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 6px; max-width: 400px;">
                            <div style="padding: 8px 14px; background: var(--bg-tertiary); border: 1px solid rgba(0,0,0,0.04); border-radius: 6px; opacity: 0.35; box-shadow: 0 0.5px 1px rgba(0,0,0,0.03);">
                                <div style="font-size: 12px; font-weight: 600; color: var(--text-primary); letter-spacing: -0.01em;">ESP32</div>
                                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 1px; font-family: 'SF Mono', Monaco, monospace; opacity: 0.8;">/firmware/esp32/</div>
                            </div>
                            <div style="padding: 10px 14px; background: linear-gradient(135deg, rgba(0,122,255,0.05) 0%, rgba(0,122,255,0.02) 100%); border: 1.5px solid #007AFF; border-radius: 6px; position: relative; box-shadow: 0 2px 8px rgba(0,122,255,0.1), 0 1px 2px rgba(0,122,255,0.08);">
                                <div style="position: absolute; top: 10px; right: 12px; width: 16px; height: 16px; background: #007AFF; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; box-shadow: 0 1px 3px rgba(0,122,255,0.3);">✓</div>
                                <div style="font-size: 13px; font-weight: 600; color: var(--text-primary); letter-spacing: -0.01em;">ESP32-C3</div>
                                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px; font-family: 'SF Mono', Monaco, monospace; opacity: 0.9;">/firmware/esp32c3/</div>
                            </div>
                            <div style="padding: 8px 14px; background: var(--bg-tertiary); border: 1px solid rgba(0,0,0,0.04); border-radius: 6px; opacity: 0.35; box-shadow: 0 0.5px 1px rgba(0,0,0,0.03);">
                                <div style="font-size: 12px; font-weight: 600; color: var(--text-primary); letter-spacing: -0.01em;">ESP32-S3</div>
                                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 1px; font-family: 'SF Mono', Monaco, monospace; opacity: 0.8;">/firmware/esp32s3/</div>
                            </div>
                        </div>

                        <!-- Arrow -->
                        <div style="flex: 0 0 auto; color: var(--text-tertiary); font-size: 24px; margin: 0 4px; font-weight: 400;">→</div>

                        <!-- Flash Status -->
                        <div style="flex: 0 0 auto; text-align: center;">
                            <div style="width: 72px; height: 72px; margin: 0 auto 10px; background: linear-gradient(135deg, rgba(0,122,255,0.06) 0%, rgba(0,122,255,0.03) 100%); border: 1px solid rgba(0,122,255,0.25); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 5px; box-shadow: 0 2px 6px rgba(0,122,255,0.08), inset 0 1px 0 rgba(255,255,255,0.5);">
                                <div style="width: 40px; height: 3px; background: rgba(0,122,255,0.12); border-radius: 2px; overflow: hidden; box-shadow: inset 0 0.5px 1px rgba(0,0,0,0.1);">
                                    <div style="width: 100%; height: 100%; background: linear-gradient(90deg, #007AFF 0%, #0051D5 100%); border-radius: 2px; box-shadow: 0 0 4px rgba(0,122,255,0.4);"></div>
                                </div>
                                <div style="width: 40px; height: 3px; background: rgba(0,122,255,0.12); border-radius: 2px; overflow: hidden; box-shadow: inset 0 0.5px 1px rgba(0,0,0,0.1);">
                                    <div style="width: 100%; height: 100%; background: linear-gradient(90deg, #007AFF 0%, #0051D5 100%); border-radius: 2px; box-shadow: 0 0 4px rgba(0,122,255,0.4);"></div>
                                </div>
                                <div style="width: 40px; height: 3px; background: rgba(0,122,255,0.12); border-radius: 2px; overflow: hidden; box-shadow: inset 0 0.5px 1px rgba(0,0,0,0.1);">
                                    <div style="width: 70%; height: 100%; background: linear-gradient(90deg, #007AFF 0%, #0051D5 100%); border-radius: 2px; box-shadow: 0 0 4px rgba(0,122,255,0.4);"></div>
                                </div>
                            </div>
                            <div style="font-size: 13px; font-weight: 600; color: var(--text-primary); letter-spacing: -0.01em;">Flashing</div>
                            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px; text-transform: uppercase; letter-spacing: 0.03em; font-weight: 500;">3 of 4</div>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div style="padding: 20px 24px;">
                    <h4 style="margin-top: 0; margin-bottom: 8px;">Firmware Router</h4>
                    <p style="margin-bottom: 12px; color: var(--text-secondary);">Automatic chip detection routes to correct firmware directory. Single <code>router.flash()</code> call handles detection, selection, and flashing.</p>
                    <a href="#router" style="color: #007AFF; text-decoration: none; font-weight: 500; font-size: 14px;">Demo →</a>
                </div>
            </div>

            <!-- Web Flasher Scaffold - Full Width Preview Card -->
            <div style="background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.08); border-radius: 12px; overflow: hidden; margin: 0 0 32px 0;">
                <!-- Preview Window -->
                <div style="background: var(--bg-secondary); border-bottom: 1px solid rgba(0,0,0,0.08); padding: 12px; overflow: hidden;">
                    <div class="preview-zoom" style="display: grid; grid-template-columns: 1.1fr 1fr 1.1fr; gap: 12px; transform: scale(0.95); transform-origin: center; transition: transform 0.3s ease;">
                        <!-- Panel 1: Configure -->
                        <div class="interface-panel" style="pointer-events: none;">
                            <div class="panel-header">
                                <div class="panel-number" style="box-shadow: none;">1</div>
                                <div class="panel-title" style="letter-spacing: -0.01em;">Configure</div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <div class="field-label" style="text-transform: uppercase; letter-spacing: 0.04em; font-size: 11px; font-weight: 600;">WiFi Network</div>
                                <div class="field-value" style="box-shadow: inset 0 1px 2px rgba(0,0,0,0.05), 0 0.5px 1px rgba(0,0,0,0.03);">MyNetwork</div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <div class="field-label" style="text-transform: uppercase; letter-spacing: 0.04em; font-size: 11px; font-weight: 600;">WiFi Password</div>
                                <div class="field-value" style="box-shadow: inset 0 1px 2px rgba(0,0,0,0.05), 0 0.5px 1px rgba(0,0,0,0.03);">••••••••</div>
                            </div>
                            <div>
                                <div class="field-label" style="text-transform: uppercase; letter-spacing: 0.04em; font-size: 11px; font-weight: 600;">MQTT Broker</div>
                                <div class="field-value" style="box-shadow: inset 0 1px 2px rgba(0,0,0,0.05), 0 0.5px 1px rgba(0,0,0,0.03);">192.168.1.100</div>
                            </div>
                        </div>

                        <!-- Panel 2: Connect & Flash -->
                        <div class="interface-panel" style="pointer-events: none;">
                            <div class="panel-header">
                                <div class="panel-number" style="box-shadow: none;">2</div>
                                <div class="panel-title" style="letter-spacing: -0.01em;">Connect & Flash</div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <div class="field-label" style="margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.04em; font-size: 11px; font-weight: 600;">Connection Status</div>
                                <div class="status-connected" style="box-shadow: 0 1px 3px rgba(52,168,83,0.15), inset 0 1px 0 rgba(255,255,255,0.3);">
                                    <div class="status-dot" style="box-shadow: 0 0 4px rgba(52,168,83,0.5);"></div>
                                    <span class="status-text">Connected to COM3</span>
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <div class="field-label" style="margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.04em; font-size: 11px; font-weight: 600;">Flashing Progress</div>
                                <div class="progress-bar-bg" style="box-shadow: inset 0 1px 2px rgba(0,0,0,0.08);">
                                    <div class="progress-bar-fill" style="width: 65%; background: linear-gradient(90deg, #007AFF 0%, #0051D5 100%); box-shadow: 0 0 6px rgba(0,122,255,0.4), inset 0 1px 0 rgba(255,255,255,0.3);"></div>
                                </div>
                                <div class="progress-text" style="letter-spacing: -0.01em;">Flashing NVS partition... 65%</div>
                            </div>
                            <div class="button-group">
                                <div class="button-primary" style="background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%); box-shadow: 0 2px 8px rgba(0,122,255,0.3), 0 1px 2px rgba(0,122,255,0.2), inset 0 1px 0 rgba(255,255,255,0.3); letter-spacing: -0.01em;">Flash Device</div>
                            </div>
                        </div>

                        <!-- Panel 3: Actions -->
                        <div class="interface-panel" style="pointer-events: none;">
                            <div class="panel-header">
                                <div class="panel-number" style="box-shadow: none;">3</div>
                                <div class="panel-title" style="letter-spacing: -0.01em;">Actions</div>
                            </div>
                            <div class="action-item" style="box-shadow: 0 0.5px 1px rgba(0,0,0,0.04);">
                                <div class="action-title" style="letter-spacing: -0.01em;">Read Config</div>
                                <div class="action-description">Read current NVS from device</div>
                            </div>
                            <div class="action-item" style="box-shadow: 0 0.5px 1px rgba(0,0,0,0.04);">
                                <div class="action-title" style="letter-spacing: -0.01em;">Erase NVS</div>
                                <div class="action-description">Clear all stored config</div>
                            </div>
                            <div class="action-item" style="margin-bottom: 0; box-shadow: 0 0.5px 1px rgba(0,0,0,0.04);">
                                <div class="action-title" style="letter-spacing: -0.01em;">Download Binary</div>
                                <div class="action-description">Save NVS partition as .bin</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div style="padding: 20px 24px;">
                    <h4 style="margin-top: 0; margin-bottom: 8px;">Web Flasher Scaffold</h4>
                    <p style="margin-bottom: 12px; color: var(--text-secondary);">JSON-based field definitions generate complete interfaces: forms, progress tracking, connection management. esptool-js integration provided.</p>
                    <a href="#scaffold" style="color: #007AFF; text-decoration: none; font-weight: 500; font-size: 14px;">Demo →</a>
                </div>
            </div>

        </div>
        <!-- Code Examples -->
        <div id="examples" class="lesson">
            <h2>Component Architecture</h2>
            <p class="lesson-intro">End-to-end workflows for common use cases.</p>

            <div style="margin: 32px -100px; background: var(--bg-secondary); border: 1px solid rgba(0,0,0,0.08); border-radius: 12px;">
                <div class="tabs" style="display: grid; grid-template-columns: 240px 1fr; gap: 0; align-items: start;">
                    <div class="tab-buttons" style="display: flex; flex-direction: column; gap: 0; background: var(--bg-secondary); border-right: 1px solid rgba(0,0,0,0.08); padding: 16px; position: sticky; top: 80px; align-self: start; border-radius: 12px 0 0 12px;">
                        <div style="font-size: 11px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 12px; padding: 0 16px;">Examples</div>
                        <button class="tab-btn active" onclick="showTab('wifi')" style="padding: 12px 16px; background: rgba(0,122,255,0.08); border: 1px solid rgba(0,122,255,0.2); border-radius: 8px; color: #007AFF; font-size: 14px; font-weight: 600; cursor: pointer; text-align: left; letter-spacing: -0.01em; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,122,255,0.1), inset 0 1px 0 rgba(255,255,255,0.3); margin-bottom: 4px;">WiFi Setup</button>
                        <button class="tab-btn" onclick="showTab('iot')" style="padding: 12px 16px; background: transparent; border: 1px solid transparent; border-radius: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; cursor: pointer; text-align: left; letter-spacing: -0.01em; transition: all 0.2s ease; margin-bottom: 4px;">IoT Device</button>
                        <button class="tab-btn" onclick="showTab('batch')" style="padding: 12px 16px; background: transparent; border: 1px solid transparent; border-radius: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; cursor: pointer; text-align: left; letter-spacing: -0.01em; transition: all 0.2s ease; margin-bottom: 4px;">Batch Generate</button>
                        <button class="tab-btn" onclick="showTab('webflash')" style="padding: 12px 16px; background: transparent; border: 1px solid transparent; border-radius: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; cursor: pointer; text-align: left; letter-spacing: -0.01em; transition: all 0.2s ease; margin-bottom: 4px;">Firmware + Config</button>
                        <button class="tab-btn" onclick="showTab('espidf')" style="padding: 12px 16px; background: transparent; border: 1px solid transparent; border-radius: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; cursor: pointer; text-align: left; letter-spacing: -0.01em; transition: all 0.2s ease; margin-bottom: 4px;">ESP-IDF Flash</button>
                        <button class="tab-btn" onclick="showTab('update')" style="padding: 12px 16px; background: transparent; border: 1px solid transparent; border-radius: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600; cursor: pointer; text-align: left; letter-spacing: -0.01em; transition: all 0.2s ease;">Read-Update-Write</button>
                    </div>

                    <div class="tab-content" style="max-width: 900px; overflow-x: auto; border-radius: 0 12px 12px 0; padding: 0; background: #1d1d1f;">
                    <div id="tab-wifi" class="tab-pane active" style="padding: 0; margin: 0; display: block;">
                        <pre class="line-numbers" style="margin: 0; padding: 0; border-radius: 0; display: block; background: transparent; font-size: 13px; line-height: 1.5; position: relative;"><code class="language-html">&lt;script src="https://jctoledo.github.io/active_wing/flasher/js/nvs-generator.js"&gt;&lt;/script&gt;
&lt;script&gt;
const generator = new NVSGenerator();

const config = {
    wifi: {
        ssid: "MyNetwork",
        password: "SecurePassword123"
    }
};

const binary = generator.generate(config, 0x6000);  // 24KB partition
// Returns: Uint8Array(24576) ready to flash at 0x9000
&lt;/script&gt;</code></pre>
                    </div>

                    <div id="tab-iot" class="tab-pane" style="display: none; padding: 0; margin: 0;">
                        <pre style="margin: 0; padding: 16px; border-radius: 0 12px 12px 0; display: block; vertical-align: top; font-size: 13px; line-height: 1.5;"><code class="language-javascript">const generator = new NVSGenerator();

// Configure a deployed sensor
const config = {
    network: {
        wifi_ssid: "FieldSite_5G",
        wifi_pass: "deployment2024",
        mqtt_broker: "mqtt.example.com",
        mqtt_port: 8883
    },
    device: {
        id: "SENSOR_A042",
        location: "Building_3_Floor_2",
        sample_rate: 60,        // seconds
        calibration_offset: -2.5,
        debug_enabled: false
    },
    tls: {
        // Certificate as byte array
        ca_cert: new Uint8Array([0x30, 0x82, 0x03, 0x75, /* ... */])
    }
};

const nvsBinary = generator.generate(config, 0x6000);

// Flash it (browser with Web Serial API)
const port = await navigator.serial.requestPort();
const esploader = await connectToESP32(port);

// Flash firmware + config
await esploader.writeFlash({
    fileArray: [
        { data: firmwareBinary, address: 0x10000 },  // app partition
        { data: nvsBinaryString, address: 0x9000 }   // NVS partition
    ],
    flashSize: 'keep'
});
</code></pre>
                    </div>

                    <div id="tab-batch" class="tab-pane" style="display: none; padding: 0; margin: 0;">
                        <pre class="line-numbers" style="margin: 0; padding: 0; border-radius: 0; display: block; background: transparent; font-size: 13px; line-height: 1.5; position: relative;"><code class="language-javascript">const fs = require('fs');
const { NVSGenerator } = require('./nvs-generator.js');

const generator = new NVSGenerator();

// Generate configs for 100 devices
const devices = [
    { id: 'DEV001', location: 'Zone_A', offset: -1.2 },
    { id: 'DEV002', location: 'Zone_A', offset: 0.8 },
    // ... 98 more
];

devices.forEach(device => {
    const config = {
        config: {
            device_id: device.id,
            location: device.location,
            cal_offset: device.offset,
            wifi_ssid: "Factory_Network",
            api_endpoint: "https://api.production.example.com"
        }
    };

    const binary = generator.generate(config, 0x6000);
    fs.writeFileSync(`nvs_${device.id}.bin`, Buffer.from(binary));
    console.log(`Generated nvs_${device.id}.bin`);
});
</code></pre>
                    </div>

                    <div id="tab-webflash" class="tab-pane" style="display: none; padding: 0; margin: 0; line-height: 0;">
                        <pre style="margin: 0; border-radius: 0 12px 12px 0;"><code class="language-javascript">// Complete web-based flashing: firmware + per-device config
// No Python, no command line, just browser + USB

// 1. Load firmware binaries (same for all devices)
const bootloaderResp = await fetch('firmware/bootloader.bin');
const bootloaderBin = await bootloaderResp.arrayBuffer();

const partitionResp = await fetch('firmware/partition-table.bin');
const partitionBin = await partitionResp.arrayBuffer();

const firmwareResp = await fetch('firmware/app.bin');
const firmwareBin = await firmwareResp.arrayBuffer();

// 2. Generate unique config for THIS device
const generator = new NVSGenerator();
const deviceConfig = {
    wifi: {
        ssid: document.getElementById('wifi-ssid').value,
        password: document.getElementById('wifi-password').value
    },
    config: {
        device_id: `DEVICE_${Date.now()}`,
        api_endpoint: "https://api.production.example.com",
        update_interval: 60
    }
};

const nvsBinary = generator.generate(deviceConfig, 0x6000);

// 3. Convert binaries to strings for esptool-js
function arrayBufferToString(buf) {
    const bytes = new Uint8Array(buf);
    let str = '';
    for (let i = 0; i < bytes.length; i++) {
        str += String.fromCharCode(bytes[i]);
    }
    return str;
}

const bootloaderStr = arrayBufferToString(bootloaderBin);
const partitionStr = arrayBufferToString(partitionBin);
const firmwareStr = arrayBufferToString(firmwareBin);
const nvsStr = arrayBufferToString(nvsBinary);

// 4. Connect to ESP32 via Web Serial
const port = await navigator.serial.requestPort({
    filters: [{ usbVendorId: 0x303a }]  // Espressif
});

const transport = new Transport(port);
const esploader = new ESPLoader(transport, 115200);
await esploader.connect();
console.log('Connected to', esploader.chipName);

// 5. Flash everything in one operation
await esploader.writeFlash({
    fileArray: [
        { data: bootloaderStr, address: 0x0 },
        { data: partitionStr,  address: 0x8000 },
        { data: nvsStr,        address: 0x9000 },   // Unique config
        { data: firmwareStr,   address: 0x10000 }
    ],
    flashSize: 'keep',
    flashMode: 'dio',
    flashFreq: '40m',
    compress: true,
    reportProgress: (fileIndex, written, total) => {
        const percent = Math.round((written / total) * 100);
        console.log(`Flashing ${fileIndex}: ${percent}%`);
        updateProgressBar(percent);
    }
});

console.log('Flash complete!');
await esploader.hardReset();

// Device boots with unique WiFi credentials
// Ready for production deployment
</code></pre>
                    </div>

                    <div id="tab-espidf" class="tab-pane" style="display: none; padding: 0; margin: 0; line-height: 0;">
                        <pre style="margin: 0; border-radius: 0 12px 0 0;"><code class="language-javascript">// 1. Generate the NVS binary in Node.js
const fs = require('fs');
const { NVSGenerator } = require('./nvs-generator.js');

const generator = new NVSGenerator();
const config = {
    wifi: {
        ssid: "ProductionNetwork",
        password: "secure_pass_2024"
    },
    config: {
        device_id: "ESP32_PROD_042",
        api_endpoint: "https://api.example.com"
    }
};

const binary = generator.generate(config, 0x6000);
fs.writeFileSync('nvs.bin', Buffer.from(binary));

console.log('Generated nvs.bin (24KB)');
</code></pre>
                        <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 24px 0;"></div>
                        <pre style="margin: 0; border-radius: 0; display: block; background: transparent; font-size: 13px; line-height: 1.5;"><code class="language-bash"># 2. Flash using esptool.py (command line)
# Flash NVS partition only
esptool.py --chip esp32c3 --port /dev/ttyUSB0 write_flash 0x9000 nvs.bin

# Or flash complete firmware + NVS
esptool.py --chip esp32c3 --port /dev/ttyUSB0 write_flash \
    0x0    bootloader.bin \
    0x8000 partition-table.bin \
    0x9000 nvs.bin \
    0x10000 firmware.bin

# Device boots with config already loaded</code></pre>
                    </div>

                    <div id="tab-update" class="tab-pane" style="display: none; padding: 0; margin: 0; line-height: 0;">
                        <pre style="margin: 0; border-radius: 0 12px 12px 0;"><code class="language-javascript">// Complete workflow: Read current config, modify it, flash back

// 1. Read current NVS partition from device
const port = await navigator.serial.requestPort();
const esploader = await connectToESP32(port);

console.log('Reading current NVS from device...');
const currentNVS = await esploader.readFlash(0x9000, 0x6000);
console.log('Read 24KB from 0x9000');

// 2. Parse binary back to config object
const generator = new NVSGenerator();
const currentConfig = generator.parse(new Uint8Array(currentNVS));

console.log('Current config:', currentConfig);
// {
//   wifi: { ssid: "OldNetwork", password: "..." },
//   config: { api_endpoint: "https://api.staging.example.com", ... }
// }

// 3. Modify specific values
currentConfig.wifi.ssid = "NewNetwork";
currentConfig.wifi.password = "new_secure_password";
currentConfig.config.api_endpoint = "https://api.production.example.com";

console.log('Updated config:', currentConfig);

// 4. Generate new binary with modified config
const updatedBinary = generator.generate(currentConfig, 0x6000);

// 5. Convert to binary string for esptool-js
let binaryString = '';
for (let i = 0; i < updatedBinary.length; i++) {
    binaryString += String.fromCharCode(updatedBinary[i]);
}

// 6. Flash ONLY the NVS partition (firmware unchanged)
console.log('Flashing updated config...');
await esploader.writeFlash({
    fileArray: [
        { data: binaryString, address: 0x9000 }
    ],
    flashSize: 'keep',
    compress: true
});

console.log('Config updated! Device will reboot.');
// Device reboots, connects to NewNetwork, hits production API
// Firmware binary at 0x10000 completely untouched
</code></pre>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Quickstart -->
        <div id="quickstart" class="lesson">
            <h2>Quickstart</h2>
            <p class="lesson-intro">Generate and flash an ESP32 config partition in under 30 seconds.</p>

            <h3>Installation</h3>
            <div class="tabs" style="margin: 24px 0;">
                <div class="tab-buttons" style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button class="install-tab-btn active" onclick="showInstallTab('cdn')" style="padding: 8px 16px; background: rgba(0,122,255,0.1); border: 1px solid rgba(0,122,255,0.3); border-radius: 6px; color: #007AFF; font-size: 13px; font-weight: 600; cursor: pointer;">Browser (CDN)</button>
                    <button class="install-tab-btn" onclick="showInstallTab('npm')" style="padding: 8px 16px; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); font-size: 13px; font-weight: 600; cursor: pointer;">Node.js (npm)</button>
                </div>

                <div id="install-cdn" class="install-pane" style="display: block;">
                    <pre><code class="language-html">&lt;script src="https://jctoledo.github.io/active_wing/flasher/js/nvs-generator.js"&gt;&lt;/script&gt;</code></pre>
                </div>

                <div id="install-npm" class="install-pane" style="display: none;">
                    <pre><code class="language-bash">npm install @esp-web-tools/nvs-generator
# or
git clone https://github.com/jctoledo/active_wing.git</code></pre>
                </div>
            </div>

            <h3>End-to-End Example</h3>
            <p>Generate WiFi config and flash to ESP32—just 10 lines:</p>

            <pre><code class="language-javascript">// 1. Generate the partition
const generator = new NVSGenerator();
const nvsBinary = generator.generate({
    wifi: { ssid: "MyNetwork", password: "SecurePass123" }
}, 0x6000);

// 2. Flash it to device
const port = await navigator.serial.requestPort();
const esploader = await connectToESP32(port);

await esploader.writeFlash({
    fileArray: [{ data: toFlashString(nvsBinary), address: 0x9000 }],
    flashSize: 'keep'
});

console.log('✓ Flashed! Device reboots with WiFi credentials.');</code></pre>

            <div style="margin-top: 16px; padding: 12px 16px; background: var(--bg-tertiary); border-radius: 8px;">
                <details style="cursor: pointer;">
                    <summary style="font-size: 13px; font-weight: 600; color: var(--text-secondary); user-select: none;">Helper functions (copy these to your project)</summary>
                    <pre style="margin-top: 12px; margin-bottom: 0;"><code class="language-javascript">// Connect to ESP32 via Web Serial
async function connectToESP32(port) {
    await port.open({ baudRate: 115200 });
    const esploader = new ESPLoader(port, { debugLogging: false });
    await esploader.connect();
    return esploader;
}

// Convert Uint8Array to string format for esptool-js
function toFlashString(bytes) {
    return String.fromCharCode(...bytes);
}</code></pre>
                </details>
            </div>

            <div style="margin-top: 24px; padding: 16px 20px; background: rgba(0,122,255,0.08); border: 1px solid rgba(0,122,255,0.2); border-radius: 8px;">
                <p style="margin: 0; font-size: 14px; color: var(--text-primary);"><strong style="color: #007AFF;">What you just did:</strong> Generated a 24KB NVS partition client-side and flashed it to ESP32 at <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; font-size: 13px;">0x9000</code>. The device will now connect to WiFi on boot. No Python, no esptool.py, no command line.</p>
            </div>
        </div>

        <!-- JavaScript API -->
        <div id="javascript" class="lesson">
            <h2>Library API</h2>
            <p class="lesson-intro">NVS binary generation in JavaScript. Compatible with browser and Node.js environments.</p>

            <h3>Script Inclusion</h3>
            <pre><code class="language-html">&lt;script src="https://jctoledo.github.io/active_wing/flasher/js/nvs-generator.js"&gt;&lt;/script&gt;</code></pre>

            <h3>Binary Generation</h3>
            <pre><code class="language-javascript">const generator = new NVSGenerator();
const config = { wifi: { ssid: "Network", password: "pass123" } };
const binary = generator.generate(config, 0x6000);  // 24KB partition
// Returns: Uint8Array(24576)</code></pre>

            <p>Top-level object keys define namespaces. Nested keys define NVS entries within those namespaces. Data types are inferred from JavaScript value types. Complete implementation examples are provided in the <a href="#examples">Code Examples</a> section.</p>

            <h3>Type Inference</h3>
            <div class="grid-2">
                <div class="card">
                    <h4>string → 0x21 (STR)</h4>
                    <p>Null-terminated. Spans multiple entries if > 8 bytes.</p>
                </div>
                <div class="card">
                    <h4>number → 0x01/0x11/0x02/0x12/0x04/0x14</h4>
                    <p>Range-based: 0-255→U8, -128-127→I8, etc.</p>
                </div>
                <div class="card">
                    <h4>boolean → 0x01 (U8)</h4>
                    <p>true=1, false=0</p>
                </div>
                <div class="card">
                    <h4>Uint8Array → 0x42 (BLOB)</h4>
                    <p>Raw bytes. Max ~4000 in V1.</p>
                </div>
            </div>

            <h3>Output Verification</h3>
            <p>Binary compatibility verification against ESP-IDF reference implementation:</p>
            <pre><code class="language-bash"># Generate with ESP-IDF
echo "config,namespace,," > test.csv
echo "port,data,u16,1883" >> test.csv
python -m esp_idf_nvs_partition_gen generate test.csv test_esp.bin 0x6000

# Generate with this library
node -e "
const gen = new (require('./nvs-generator.js'))();
const bin = gen.generate({config: {port: 1883}}, 0x6000);
require('fs').writeFileSync('test_js.bin', Buffer.from(bin));
"

# Compare
diff test_esp.bin test_js.bin
# Should be identical</code></pre>
        </div>

        <!-- Firmware Router -->
        <div id="router" class="lesson">
            <h2>Firmware Router</h2>
            <p class="lesson-intro">Single-method abstraction for multi-variant ESP32 firmware deployment. Chip detection, firmware selection, and NVS generation handled automatically.</p>

            <h3>Minimal API</h3>
            <p>The router abstracts all esptool-js operations, chip detection, and binary management into a single method call:</p>

            <pre><code class="language-javascript">const router = new FirmwareRouter('/firmware');  // Base path to firmware directory

await router.flash({
    config: { wifi: { ssid: "Network", password: "pass123" } },
    onProgress: (percent, stage) => {
        console.log(`${stage}: ${percent}%`);
    }
});
// Complete: chip detected, firmware selected, NVS generated, device flashed</code></pre>

            <h3>Directory Convention</h3>
            <p>The router expects a standard directory structure. No configuration mapping required:</p>

            <pre><code class="language-bash">/firmware/
  ├── esp32/
  │   ├── bootloader.bin
  │   ├── partitions.bin
  │   └── app.bin
  ├── esp32c3/
  │   ├── bootloader.bin
  │   ├── partitions.bin
  │   └── app.bin
  └── esp32s3/
      ├── bootloader.bin
      ├── partitions.bin
      └── app.bin</code></pre>

            <h3>Full API Options</h3>
            <pre><code class="language-javascript">await router.flash({
    // Required: Configuration to write to NVS
    config: {
        wifi: { ssid: "Network", password: "pass" },
        device: { id: "ESP32_001" }
    },

    // Optional: NVS partition size (default: 0x6000 / 24KB)
    nvsSize: 0x6000,

    // Optional: Progress callback
    onProgress: (percent, stage) => {
        // stage: 'connecting', 'detecting', 'loading', 'flashing', 'complete'
        updateUI(percent, stage);
    },

    // Optional: Override automatic chip detection
    chipType: 'ESP32-C3',

    // Optional: Serial port (if not provided, prompts user)
    port: existingPort
});</code></pre>

            <h3>Implementation</h3>
            <p>Complete reference implementation demonstrating convention-based routing:</p>
            <pre><code class="language-javascript">class FirmwareRouter {
    constructor(basePath = '/firmware') {
        this.basePath = basePath;
        this.nvsGenerator = new NVSGenerator();
        this.chipMap = {
            'ESP32': 'esp32',
            'ESP32-C3': 'esp32c3',
            'ESP32-S3': 'esp32s3',
            'ESP32-S2': 'esp32s2',
            'ESP32-C6': 'esp32c6'
        };
    }

    async flash(options) {
        const {
            config,
            nvsSize = 0x6000,
            onProgress = () => {},
            chipType = null,
            port = null
        } = options;

        // Stage 1: Connect to device
        onProgress(0, 'connecting');
        const serialPort = port || await navigator.serial.requestPort({
            filters: [{ usbVendorId: 0x303a }]  // Espressif
        });

        const transport = new Transport(serialPort);
        const esploader = new ESPLoader(transport, 115200);
        await esploader.connect();

        // Stage 2: Detect chip type
        onProgress(20, 'detecting');
        const detectedChip = chipType || esploader.chipName;
        const chipDir = this.chipMap[detectedChip];

        if (!chipDir) {
            throw new Error(`Unsupported chip: ${detectedChip}`);
        }

        // Stage 3: Load firmware binaries
        onProgress(30, 'loading');
        const [bootloader, partitions, app] = await Promise.all([
            fetch(`${this.basePath}/${chipDir}/bootloader.bin`).then(r => r.arrayBuffer()),
            fetch(`${this.basePath}/${chipDir}/partitions.bin`).then(r => r.arrayBuffer()),
            fetch(`${this.basePath}/${chipDir}/app.bin`).then(r => r.arrayBuffer())
        ]);

        // Stage 4: Generate NVS partition
        const nvsBinary = this.nvsGenerator.generate(config, nvsSize);

        // Stage 5: Flash all binaries
        onProgress(50, 'flashing');
        const fileArray = [
            { data: this._toStr(bootloader), address: 0x1000 },
            { data: this._toStr(partitions), address: 0x8000 },
            { data: this._toStr(nvsBinary), address: 0x9000 },
            { data: this._toStr(app), address: 0x10000 }
        ];

        await esploader.writeFlash({
            fileArray,
            flashSize: 'keep',
            compress: true,
            reportProgress: (idx, written, total) => {
                const percent = 50 + Math.round((written / total) * 45);
                onProgress(percent, 'flashing');
            }
        });

        onProgress(100, 'complete');
        await esploader.hardReset();
    }

    _toStr(buffer) {
        const bytes = buffer instanceof Uint8Array ? buffer : new Uint8Array(buffer);
        let str = '';
        for (let i = 0; i < bytes.length; i++) {
            str += String.fromCharCode(bytes[i]);
        }
        return str;
    }
}</code></pre>

            <h3>Complete Example</h3>
            <pre><code class="language-javascript">// HTML button handler
document.getElementById('flashBtn').addEventListener('click', async () => {
    const router = new FirmwareRouter('/firmware');

    const config = {
        wifi: {
            ssid: document.getElementById('ssid').value,
            password: document.getElementById('password').value
        },
        device: {
            id: `DEV_${Date.now()}`
        }
    };

    try {
        await router.flash({
            config,
            onProgress: (percent, stage) => {
                document.getElementById('progress').value = percent;
                document.getElementById('status').textContent = stage;
            }
        });

        alert('Device flashed successfully!');
    } catch (err) {
        alert(`Flash failed: ${err.message}`);
    }
});</code></pre>

            <h3>Operational Flow</h3>
            <div style="background: var(--bg-secondary); border: 1px solid rgba(0,0,0,0.08); border-radius: 12px; padding: 32px 40px; margin: 32px 0;">
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px;">
                    <!-- Step 1 -->
                    <div style="flex: 1; text-align: center;">
                        <div style="width: 52px; height: 52px; margin: 0 auto 12px; background: linear-gradient(135deg, rgba(0,122,255,0.08) 0%, rgba(0,122,255,0.04) 100%); border: 1px solid rgba(0,122,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; color: #007AFF; box-shadow: 0 2px 6px rgba(0,122,255,0.1), inset 0 1px 0 rgba(255,255,255,0.4);">1</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; letter-spacing: -0.01em;">Call</div>
                        <div style="font-size: 12px; color: var(--text-secondary); font-family: 'SF Mono', Monaco, monospace; background: var(--bg-tertiary); padding: 4px 8px; border-radius: 4px; display: inline-block;">router.flash()</div>
                    </div>

                    <!-- Arrow -->
                    <div style="flex: 0 0 auto; color: var(--text-tertiary); font-size: 20px; margin: 0 -4px;">→</div>

                    <!-- Step 2 -->
                    <div style="flex: 1; text-align: center;">
                        <div style="width: 52px; height: 52px; margin: 0 auto 12px; background: linear-gradient(135deg, rgba(0,122,255,0.08) 0%, rgba(0,122,255,0.04) 100%); border: 1px solid rgba(0,122,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; color: #007AFF; box-shadow: 0 2px 6px rgba(0,122,255,0.1), inset 0 1px 0 rgba(255,255,255,0.4);">2</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; letter-spacing: -0.01em;">Detect</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Chip identified</div>
                    </div>

                    <!-- Arrow -->
                    <div style="flex: 0 0 auto; color: var(--text-tertiary); font-size: 20px; margin: 0 -4px;">→</div>

                    <!-- Step 3 -->
                    <div style="flex: 1; text-align: center;">
                        <div style="width: 52px; height: 52px; margin: 0 auto 12px; background: linear-gradient(135deg, rgba(0,122,255,0.08) 0%, rgba(0,122,255,0.04) 100%); border: 1px solid rgba(0,122,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; color: #007AFF; box-shadow: 0 2px 6px rgba(0,122,255,0.1), inset 0 1px 0 rgba(255,255,255,0.4);">3</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; letter-spacing: -0.01em;">Route</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Binaries loaded</div>
                    </div>

                    <!-- Arrow -->
                    <div style="flex: 0 0 auto; color: var(--text-tertiary); font-size: 20px; margin: 0 -4px;">→</div>

                    <!-- Step 4 -->
                    <div style="flex: 1; text-align: center;">
                        <div style="width: 52px; height: 52px; margin: 0 auto 12px; background: linear-gradient(135deg, rgba(0,122,255,0.08) 0%, rgba(0,122,255,0.04) 100%); border: 1px solid rgba(0,122,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; color: #007AFF; box-shadow: 0 2px 6px rgba(0,122,255,0.1), inset 0 1px 0 rgba(255,255,255,0.4);">4</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; letter-spacing: -0.01em;">Generate</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">NVS created</div>
                    </div>

                    <!-- Arrow -->
                    <div style="flex: 0 0 auto; color: var(--text-tertiary); font-size: 20px; margin: 0 -4px;">→</div>

                    <!-- Step 5 -->
                    <div style="flex: 1; text-align: center;">
                        <div style="width: 52px; height: 52px; margin: 0 auto 12px; background: linear-gradient(135deg, rgba(52,168,83,0.08) 0%, rgba(52,168,83,0.04) 100%); border: 1px solid rgba(52,168,83,0.25); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; color: #34a853; box-shadow: 0 2px 6px rgba(52,168,83,0.12), inset 0 1px 0 rgba(255,255,255,0.4);">✓</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; letter-spacing: -0.01em;">Flash</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Complete</div>
                    </div>
                </div>
            </div>

            <div class="callout">
                <div class="callout-title">Convention over configuration</div>
                <div class="callout-body">
                    The router requires no mapping configuration. Directory structure conventions determine firmware paths.
                    Chip variant support is automatic—add a new directory (e.g., esp32c6/) with standard binary names, and the router handles it.
                    The entire flashing workflow reduces to a single method call with a configuration object.
                    Serial port selection, chip detection, binary fetching, NVS generation, and flash operations execute transparently.
                </div>
            </div>

            <h3>Build Automation</h3>
            <p>Firmware directory population can be automated from ESP-IDF build artifacts:</p>
            <pre><code class="language-javascript">// deploy-firmware.js - runs after ESP-IDF builds
const fs = require('fs');
const path = require('path');

const targets = ['esp32', 'esp32c3', 'esp32s3'];

targets.forEach(target => {
    const buildDir = `build_${target}`;
    const outputDir = `web/firmware/${target}`;

    // Create output directory
    fs.mkdirSync(outputDir, { recursive: true });

    // Copy binaries to conventional locations
    fs.copyFileSync(
        `${buildDir}/bootloader/bootloader.bin`,
        `${outputDir}/bootloader.bin`
    );
    fs.copyFileSync(
        `${buildDir}/partition_table/partition-table.bin`,
        `${outputDir}/partitions.bin`
    );
    fs.copyFileSync(
        `${buildDir}/firmware.bin`,
        `${outputDir}/app.bin`
    );

    console.log(`✓ Deployed ${target}`);
});</code></pre>

            <h3>CI/CD Integration</h3>
            <pre><code class="language-yaml"># .github/workflows/build-firmware.yml
name: Build Multi-Platform Firmware
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [esp32, esp32c3, esp32s3]

    steps:
      - uses: actions/checkout@v3
      - uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: v5.1
          target: ${{ matrix.target }}

      - name: Build firmware
        run: |
          idf.py set-target ${{ matrix.target }}
          idf.py build

      - name: Deploy to web directory
        run: |
          mkdir -p web/firmware/${{ matrix.target }}
          cp build/bootloader/bootloader.bin web/firmware/${{ matrix.target }}/
          cp build/partition_table/partition-table.bin web/firmware/${{ matrix.target }}/partitions.bin
          cp build/firmware.bin web/firmware/${{ matrix.target }}/app.bin

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: firmware-${{ matrix.target }}
          path: web/firmware/${{ matrix.target }}/</code></pre>

            <div class="callout">
                <div class="callout-title">Zero-configuration deployment</div>
                <div class="callout-body">
                    CI/CD pipelines build firmware for all target chips, deploy binaries to conventional paths, and publish to web servers.
                    The router automatically supports new chip variants when directories appear—no code changes, no configuration files, no manual synchronization.
                    Adding ESP32-C6 support requires only adding the target to the build matrix. The router detects and routes to it immediately.
                </div>
            </div>
        </div>

        <!-- Binary Format -->
        <div id="format" class="lesson">
            <h2>NVS Binary Format (V1)</h2>
            <p class="lesson-intro">Understanding ESP-IDF's flash-based key-value storage format reveals the mechanics behind runtime configuration. This specification enables compatible implementations across any programming language.</p>

            <h3>The Page Architecture</h3>

            <div style="background: var(--bg-secondary); border: 1px solid rgba(0,0,0,0.08); border-radius: 12px; padding: 32px 40px; margin: 32px 0;">
                <!-- Description -->
                <p style="margin: 0 0 28px 0; font-size: 14px; line-height: 1.6; color: var(--text-primary);">
                    Flash memory operates in fixed-size blocks called pages, and NVS partitions organize data around this constraint. Each 4096-byte page begins with a 32-byte header describing its state, followed by 126 fixed-size entries of 32 bytes each. This fixed-entry design simplifies addressing—finding entry N requires no pointer chasing, just arithmetic: <code style="background: var(--code-inline-bg); padding: 2px 6px; border-radius: 4px; font-family: 'SF Mono', Monaco, monospace; font-size: 12px;">byte offset = 32 + (N × 32)</code>.
                </p>

                <!-- Visual Layout -->
                <div style="display: flex; gap: 12px; align-items: stretch; overflow-x: auto; padding: 4px 0;">
                    <!-- Header Block -->
                    <div style="min-width: 90px; padding: 14px 16px; background: linear-gradient(135deg, rgba(0,122,255,0.08) 0%, rgba(0,122,255,0.04) 100%); border: 1px solid rgba(0,122,255,0.2); border-radius: 8px; box-shadow: 0 2px 6px rgba(0,122,255,0.1), inset 0 1px 0 rgba(255,255,255,0.4); display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-size: 13px; font-weight: 600; color: #007AFF; margin-bottom: 4px; letter-spacing: -0.01em;">Header</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-secondary);">32 bytes</div>
                    </div>

                    <!-- Entry 0 -->
                    <div style="min-width: 80px; padding: 14px 16px; background: var(--bg-tertiary); border: 1px solid rgba(0,0,0,0.06); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; letter-spacing: -0.01em;">Entry 0</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-secondary);">32 bytes</div>
                    </div>

                    <!-- Entry 1 -->
                    <div style="min-width: 80px; padding: 14px 16px; background: var(--bg-tertiary); border: 1px solid rgba(0,0,0,0.06); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; letter-spacing: -0.01em;">Entry 1</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-secondary);">32 bytes</div>
                    </div>

                    <!-- Ellipsis -->
                    <div style="display: flex; align-items: center; padding: 0 8px;">
                        <div style="color: var(--text-tertiary); font-size: 14px; font-weight: 500; letter-spacing: 0.02em;">… 124 more …</div>
                    </div>

                    <!-- Entry 126 -->
                    <div style="min-width: 80px; padding: 14px 16px; background: var(--bg-tertiary); border: 1px solid rgba(0,0,0,0.06); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; letter-spacing: -0.01em;">Entry 126</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-secondary);">32 bytes</div>
                    </div>

                    <!-- Unused Block -->
                    <div style="min-width: 80px; padding: 14px 16px; background: var(--bg-tertiary); border: 1px solid rgba(0,0,0,0.04); border-radius: 8px; opacity: 0.35; display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; letter-spacing: -0.01em;">Unused</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-secondary);">28 bytes</div>
                    </div>
                </div>

                <!-- Math Callout -->
                <div style="margin-top: 24px; padding: 14px 20px; background: rgba(0,122,255,0.06); border: 1px solid rgba(0,122,255,0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 14px; font-weight: 600; color: #007AFF; letter-spacing: -0.01em;">(4096 - 32) ÷ 32 = 127</div>
                    <div style="color: var(--text-tertiary); font-size: 14px;">→</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">126 entries + 28 bytes unused</div>
                </div>
            </div>

            <h3>Page Header (32 bytes)</h3>
            <p>Each page header encapsulates metadata critical to ESP-IDF's wear leveling and corruption detection mechanisms:</p>

            <div class="visual-box" style="padding: 24px; margin-left: -100px; margin-right: -100px; max-width: none;">
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; font-size: 12px; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;">
                    <div style="padding: 14px 16px; background: rgba(0,0,0,0.04); border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-radius: 12px; transition: all 0.2s ease;">
                        <div style="font-weight: 600; margin-bottom: 4px; letter-spacing: -0.01em; color: var(--text-primary);">State</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-tertiary);">0-3 (4B)</div>
                    </div>
                    <div style="padding: 14px 16px; background: rgba(0,0,0,0.035); border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 2px 6px rgba(0,0,0,0.05); border-radius: 12px; transition: all 0.2s ease;">
                        <div style="font-weight: 600; margin-bottom: 4px; letter-spacing: -0.01em; color: var(--text-secondary);">Sequence</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-tertiary);">4-7 (4B)</div>
                    </div>
                    <div style="padding: 14px 16px; background: rgba(0,0,0,0.035); border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 2px 6px rgba(0,0,0,0.05); border-radius: 12px; transition: all 0.2s ease;">
                        <div style="font-weight: 600; margin-bottom: 4px; letter-spacing: -0.01em; color: var(--text-secondary);">Version</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-tertiary);">8-11 (4B)</div>
                    </div>
                    <div style="padding: 14px 16px; background: var(--bg-tertiary); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 2px 6px rgba(0,0,0,0.04); border-radius: 12px; opacity: 0.5;">
                        <div style="font-weight: 600; margin-bottom: 4px; letter-spacing: -0.01em;">Reserved</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-tertiary);">12-27 (16B)</div>
                    </div>
                    <div style="padding: 14px 16px; background: rgba(0,0,0,0.04); border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-radius: 12px; transition: all 0.2s ease;">
                        <div style="font-weight: 600; margin-bottom: 4px; letter-spacing: -0.01em; color: var(--text-primary);">CRC32</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-tertiary);">28-31 (4B)</div>
                    </div>
                </div>
            </div>

            <p>The <strong>state field</strong> uses specific bit patterns to indicate page lifecycle: <code>0xFFFFFFFE</code> marks an active page accepting writes, while other values signal full or erased states. Flash memory cannot flip bits from 0→1 without erasing entire blocks, so state transitions follow a one-way pattern until the next erase cycle.</p>

            <p>The <strong>sequence number</strong> implements wear leveling by rotating writes across pages. When a page fills, ESP-IDF writes to the next page with an incremented sequence. Over thousands of power cycles, this distributes flash wear evenly, extending device lifespan from ~10,000 to potentially millions of configuration updates.</p>

            <p>The <strong>CRC32 checksum</strong> validates header integrity. Corrupted headers indicate flash degradation or interrupted writes, triggering recovery procedures that scan for the most recent valid page.</p>

            <h3>Entry Structure (32 bytes)</h3>
            <p>Entries store individual key-value pairs using a carefully packed 32-byte layout that balances flexibility with flash efficiency:</p>

            <div class="visual-box" style="padding: 24px; margin-left: -100px; margin-right: -100px; max-width: none;">
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; font-size: 12px; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;">
                    <div style="padding: 14px 16px; background: rgba(0,0,0,0.03); border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 2px 6px rgba(0,0,0,0.04); border-radius: 12px; transition: all 0.2s ease;">
                        <div style="font-weight: 600; margin-bottom: 4px; letter-spacing: -0.01em; color: var(--text-secondary);">NS Index</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-tertiary);">0 (1B)</div>
                    </div>
                    <div style="padding: 14px 16px; background: rgba(0,0,0,0.03); border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 2px 6px rgba(0,0,0,0.04); border-radius: 12px; transition: all 0.2s ease;">
                        <div style="font-weight: 600; margin-bottom: 4px; letter-spacing: -0.01em; color: var(--text-secondary);">Type</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-tertiary);">1 (1B)</div>
                    </div>
                    <div style="padding: 14px 16px; background: rgba(0,0,0,0.03); border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 2px 6px rgba(0,0,0,0.04); border-radius: 12px; transition: all 0.2s ease;">
                        <div style="font-weight: 600; margin-bottom: 4px; letter-spacing: -0.01em; color: var(--text-secondary);">Span</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-tertiary);">2 (1B)</div>
                    </div>
                    <div style="padding: 14px 16px; background: var(--bg-tertiary); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 2px 6px rgba(0,0,0,0.04); border-radius: 12px; opacity: 0.4;">
                        <div style="font-weight: 600; margin-bottom: 4px; letter-spacing: -0.01em;">Rsv</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-tertiary);">3 (1B)</div>
                    </div>
                    <div style="padding: 14px 16px; background: rgba(0,0,0,0.04); border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-radius: 12px; grid-column: span 2; transition: all 0.2s ease;">
                        <div style="font-weight: 600; margin-bottom: 4px; letter-spacing: -0.01em; color: var(--text-primary);">Key</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-tertiary);">4-19 (16B)</div>
                    </div>
                    <div style="padding: 14px 16px; background: rgba(0,0,0,0.04); border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-radius: 12px; transition: all 0.2s ease;">
                        <div style="font-weight: 600; margin-bottom: 4px; letter-spacing: -0.01em; color: var(--text-primary);">Data</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: var(--text-tertiary);">20-31 (12B)</div>
                    </div>
                </div>
            </div>

            <p>The <strong>namespace index</strong> provides organization without string overhead. Rather than repeating namespace names like "wifi" or "config" in every entry, namespaces receive numeric indices (0-255), saving 15+ bytes per entry. The tradeoff: namespace definitions must appear before their use.</p>

            <p>The <strong>type byte</strong> determines how the remaining bytes are interpreted. A U16 stores its value directly in bytes 20-21. A string stores length in bytes 20-23 and begins data at byte 24. This polymorphic design allows diverse data types within a uniform structure.</p>

            <p>The <strong>span field</strong> solves the size constraint problem. When data exceeds 8 bytes, span indicates how many consecutive entries the item occupies. A 100-byte blob with span=5 consumes entries N through N+4, with data flowing across all of them.</p>

            <h3>Entry Types</h3>
            <p>The type system balances JavaScript compatibility with C firmware requirements. Each type code maps to specific byte layouts:</p>

            <div class="grid-2">
                <div class="card">
                    <h4>0x01 - U8</h4>
                    <p>Single unsigned byte at offset 20. Remaining 11 bytes filled with 0xFF. Efficient for boolean flags and small enumerations.</p>
                </div>
                <div class="card">
                    <h4>0x11 - I8</h4>
                    <p>Signed byte using two's complement representation. Stores values -128 to +127.</p>
                </div>
                <div class="card">
                    <h4>0x02 - U16</h4>
                    <p>Little-endian uint16 at bytes 20-21. Common for port numbers and counts.</p>
                </div>
                <div class="card">
                    <h4>0x12 - I16</h4>
                    <p>Signed 16-bit integer in little-endian format. Range: -32,768 to +32,767.</p>
                </div>
                <div class="card">
                    <h4>0x04 - U32</h4>
                    <p>Little-endian uint32 at bytes 20-23. Handles timestamps, large counters, IPv4 addresses.</p>
                </div>
                <div class="card">
                    <h4>0x14 - I32</h4>
                    <p>Signed 32-bit integer. ESP-IDF's most common numeric type.</p>
                </div>
                <div class="card">
                    <h4>0x21 - STR</h4>
                    <p>String length at bytes 20-23, data begins at byte 24. For strings exceeding 8 bytes, additional entries store continuation data.</p>
                </div>
                <div class="card">
                    <h4>0x42 - BLOB</h4>
                    <p>Binary data with size at bytes 20-23. Supports certificates, firmware chunks, arbitrary byte sequences up to ~4KB.</p>
                </div>
            </div>

            <h3>Multi-Entry Items</h3>
            <p>When data exceeds the 8 bytes available in a single entry (bytes 24-31), the format employs span chaining. The first entry contains metadata (length, type, key), while subsequent entries become pure data containers.</p>

            <p>Consider storing the string "HomeWiFiNetwork" (15 characters + null terminator = 16 bytes). The first entry stores the initial 8 bytes: "HomeWiFi". The second entry stores the remaining 8 bytes: "Network\0". The span field in the first entry indicates span=2, signaling that entries N and N+1 constitute a single logical item.</p>

            <p>For a 100-byte blob: the first entry holds metadata and the first 8 data bytes. The remaining 92 bytes require ⌈92 ÷ 32⌉ = 3 additional entries (96 bytes of capacity, 4 bytes unused). Total span: 1 header entry + 3 data entries = span of 4.</p>

            <h3>Namespace Entries</h3>
            <p>Namespaces provide logical grouping without hierarchical path overhead. Before storing <code>wifi.ssid</code>, a namespace entry establishes the "wifi" namespace and assigns it an index. Subsequent entries reference this index rather than repeating the string "wifi".</p>

            <div class="visual-box" style="padding: 24px; margin-left: -100px; margin-right: -100px; max-width: none;">
                <div style="display: flex; gap: 20px; font-size: 12px; font-family: 'SF Mono', Monaco, monospace; align-items: center;">
                    <div style="flex: 1; padding: 16px 20px; background: rgba(0,0,0,0.03); border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 2px 6px rgba(0,0,0,0.04); border-radius: 12px; transition: all 0.2s ease;">
                        <div style="color: var(--text-secondary); font-weight: 600; margin-bottom: 6px; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif; letter-spacing: -0.01em;">NS Definition</div>
                        <div style="color: var(--text-primary); font-size: 11px;">01 00 01 FF "config\0" ... → <span style="font-weight: 600; color: var(--text-primary);">index=1</span></div>
                    </div>
                    <div style="color: var(--text-tertiary); font-size: 18px; opacity: 0.5;">→</div>
                    <div style="flex: 1; padding: 16px 20px; background: rgba(0,0,0,0.04); border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-radius: 12px; transition: all 0.2s ease;">
                        <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 6px; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif; letter-spacing: -0.01em;">Data Entry</div>
                        <div style="color: var(--text-primary); font-size: 11px;">01 02 01 FF "port\0" 5B 07 ... → <span style="font-weight: 600;">ns_index=1</span></div>
                    </div>
                    <div style="margin-left: auto; padding: 10px 16px; background: rgba(0,0,0,0.06); border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px); border-radius: 10px; color: var(--text-primary); font-weight: 600; white-space: nowrap; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif; letter-spacing: -0.02em; box-shadow: 0 1px 4px rgba(0,0,0,0.05);">
                        Saves 15B per entry
                    </div>
                </div>
            </div>

            <p>All subsequent entries with <code>ns_index = 1</code> belong to the "config" namespace. This index-based approach reduces per-entry overhead from ~15 bytes (namespace string) to 1 byte (index), significant when partitions store dozens of configuration values.</p>

            <h3>Concrete Example: Storing port=1883</h3>
            <p>Storing the MQTT port number demonstrates the format in practice. The value 1883 fits in a U16 (range 0-65535), requiring a single entry in the "config" namespace:</p>

            <div class="visual-box" style="padding: 24px; margin-left: -100px; margin-right: -100px; max-width: none;">
                <div style="display: flex; gap: 16px; font-size: 12px; font-family: 'SF Mono', Monaco, monospace; align-items: center;">
                    <div style="padding: 14px 18px; background: var(--bg-tertiary); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 2px 6px rgba(0,0,0,0.04); border-radius: 12px;">
                        <div style="font-weight: 600; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif; letter-spacing: -0.01em; margin-bottom: 4px; color: var(--text-secondary);">Input</div>
                        <div style="font-size: 11px;">{config: {port: 1883}}</div>
                    </div>
                    <div style="color: var(--text-tertiary); font-size: 18px; opacity: 0.5;">→</div>
                    <div style="flex: 1; padding: 14px 18px; background: rgba(0,0,0,0.04); border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-radius: 12px;">
                        <div style="font-weight: 600; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif; letter-spacing: -0.01em; margin-bottom: 6px; color: var(--text-primary);">Binary</div>
                        <div style="font-size: 11px; line-height: 1.6;">
                            <span style="background: rgba(0,0,0,0.08); padding: 3px 6px; border-radius: 6px; font-weight: 500;">01</span>
                            <span style="background: rgba(0,0,0,0.08); padding: 3px 6px; border-radius: 6px; font-weight: 500;">02</span>
                            <span style="background: rgba(0,0,0,0.08); padding: 3px 6px; border-radius: 6px; font-weight: 500;">01</span>
                            <span style="opacity:0.3">FF</span>
                            <span style="background: rgba(0,0,0,0.08); padding: 3px 6px; border-radius: 6px; font-weight: 500;">70 6F 72 74 00</span>
                            <span style="opacity:0.3">FF...</span>
                            <span style="background: rgba(0,0,0,0.08); padding: 3px 6px; border-radius: 6px; font-weight: 500;">5B 07</span>
                            <span style="opacity:0.3">FF...</span>
                        </div>
                    </div>
                    <div style="padding: 10px 16px; background: rgba(0,0,0,0.06); border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px); border-radius: 10px; color: var(--text-primary); font-weight: 600; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif; letter-spacing: -0.02em; box-shadow: 0 1px 4px rgba(0,0,0,0.05);">
                        1883 → 0x075B → 5B 07 (LE)
                    </div>
                </div>
            </div>

            <p>The value 1883 appears as <code>5B 07</code> due to little-endian byte ordering: 1883 = 0x075B = 0x5B (low byte) followed by 0x07 (high byte). This byte order matches ESP32's ARM Cortex architecture, eliminating endian conversion overhead during firmware reads.</p>

            <div class="callout">
                <div class="callout-title">CRC32 Integrity Checking</div>
                <div class="callout-body">
                    ESP-IDF employs CRC32 (polynomial 0x04C11DB7) for corruption detection at two levels. Page headers include a CRC32 covering bytes 0-27, validating metadata integrity. Individual entries also carry CRCs covering bytes 0-27 of the entry structure. For multi-span items, only the first entry contains a CRC that covers all data across all spanned entries, optimizing both storage and validation performance.
                </div>
            </div>

            <h3>Memory Layout Visualizer</h3>
            <p>Interactive byte-level visualization of NVS structures. Hover over bytes to see field details.</p>

            <div class="hex-visualizer">
                <div class="hex-tabs">
                    <button class="hex-tab active" data-example="page-header">Page Header</button>
                    <button class="hex-tab" data-example="u16-entry">U16 Entry</button>
                    <button class="hex-tab" data-example="string-entry">String Entry</button>
                    <button class="hex-tab" data-example="namespace">Namespace Entry</button>
                </div>

                <div class="hex-viewer">
                    <div class="hex-content">
                        <div class="hex-offsets">
                            <div class="offset-label">Offset</div>
                            <div class="offset" data-offset="0x00">00</div>
                            <div class="offset" data-offset="0x08">08</div>
                            <div class="offset" data-offset="0x10">10</div>
                            <div class="offset" data-offset="0x18">18</div>
                        </div>
                        <div class="hex-bytes" id="hex-bytes-container">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    <div class="hex-info" id="hex-info-panel">
                        <div class="hex-info-empty">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="16" cy="16" r="14"/>
                                <path d="M16 12v8M16 22v2"/>
                            </svg>
                            <p>Hover over bytes to see details</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Flash -->
        <div id="flash" class="lesson">
            <h2>Device Flashing Operations</h2>
            <p class="lesson-intro">Generated binaries are written to ESP32 flash memory via Web Serial API integration.</p>

            <h3>NVS Partition Location</h3>
            <p>The partition table (partitions.csv) defines NVS partition placement in flash memory. Standard partition layout:</p>

            <pre><code class="language-bash">0x1000  : bootloader.bin
0x8000  : partition-table.bin
0x9000  : nvs.bin          ← NVS partition location
0x10000 : app.bin</code></pre>

            <p>The 0x9000 address is conventional but not mandatory. Partition tables may locate NVS at any address. Flash operations must target the address specified in the partition table.</p>

            <h3>Web Serial Integration</h3>
            <p>Chrome's Web Serial API provides USB serial port access. esptool-js implements the ESP32 ROM bootloader protocol in JavaScript. Combined, these enable browser-based flash operations.</p>

            <pre><code class="language-javascript">const nvsBinary = generator.generate(config, 0x6000);

// esptool-js requires binary string format, not Uint8Array
let nvsString = '';
for (let i = 0; i < nvsBinary.length; i++) {
    nvsString += String.fromCharCode(nvsBinary[i]);
}

await espLoader.writeFlash({
    fileArray: [
        { data: firmwareBinary, address: 0x10000 },
        { data: nvsString, address: 0x9000 }
    ],
    flashSize: 'keep',
    compress: true
});</code></pre>

            <h3>Browser Compatibility Requirements</h3>
            <p>Web Serial API availability is limited to Chromium-based browsers: Chrome 89+, Edge 89+, Opera 75+. Firefox, Safari, and mobile browsers lack Web Serial support. Desktop Chrome or equivalent Chromium browser is required.</p>

            <p>USB port access requires explicit user permission per session. Permission requests must originate from user gestures (button clicks):</p>

            <pre><code class="language-javascript">button.onclick = async () => {
    const port = await navigator.serial.requestPort({
        filters: [{ usbVendorId: 0x303a }]  // Espressif vendor ID
    });
};</code></pre>
        </div>

        <!-- Read -->
        <div id="read" class="lesson">
            <h2>Firmware-Side Configuration Access</h2>
            <p class="lesson-intro">ESP32 firmware accesses NVS data through ESP-IDF's nvs_flash API. Implementation examples for C, Arduino, and Rust.</p>

            <h3>ESP-IDF (C)</h3>
            <pre><code class="language-c">#include "nvs_flash.h"
#include "nvs.h"

nvs_flash_init();

nvs_handle_t h;
nvs_open("config", NVS_READONLY, &h);

char ssid[32];
size_t len = sizeof(ssid);
nvs_get_str(h, "wifi_ssid", ssid, &len);

uint16_t port;
nvs_get_u16(h, "port", &port);

nvs_close(h);</code></pre>

            <h3>Arduino</h3>
            <pre><code class="language-c">#include &lt;Preferences.h&gt;

Preferences p;
p.begin("config", true);

String ssid = p.getString("wifi_ssid", "");
uint16_t port = p.getUShort("port", 1883);

p.end();</code></pre>

            <h3>Rust</h3>
            <pre><code class="language-rust">use esp_idf_svc::nvs::*;

let nvs = EspDefaultNvsPartition::take()?;
let ns = EspNvs::new(nvs, "config", true)?;

let mut buf = [0u8; 32];
let ssid = ns.get_str("wifi_ssid", &mut buf)?;
let port: u16 = ns.get_u16("port")?;</code></pre>

            <div class="callout">
                <div class="callout-title">Naming Constraints</div>
                <div class="callout-body">Namespace and key names are limited to 15 characters maximum, alphanumeric plus underscore. Names are case-sensitive. Exact name matching is required between JavaScript generation and firmware access routines.</div>
            </div>

            <h3>Configuration Updates Without Firmware Reflashing</h3>
            <p>Configuration modification workflow: read existing NVS from device, modify values in JavaScript, regenerate partition, write updated partition back:</p>

            <pre><code class="language-javascript">// Read from device
const bytes = await espLoader.readFlash(0x9000, 0x6000);
const config = parseNVSConfig(bytes, 'config');

// Modify
config.wifi_password = "NewPassword";

// Regenerate and flash
const updated = generator.generate({ config }, 0x6000);
let str = '';
for (let i = 0; i < updated.length; i++) str += String.fromCharCode(updated[i]);
await espLoader.writeFlash({
    fileArray: [{ data: str, address: 0x9000 }],
    flashSize: 'keep'
});</code></pre>
        </div>

        <!-- Template -->
        <div id="template" class="lesson">
            <h2>Web Flasher Scaffold Framework</h2>
            <p class="lesson-intro">NPX-based template generating complete flasher interfaces from declarative configuration files.</p>

            <h3>Scaffold Generation</h3>
            <pre><code class="language-bash">npx create-esp32-flasher my-flasher
cd my-flasher
npm start</code></pre>

            <h3>Architecture</h3>
            <p>Field definitions in config.json drive interface generation. The template generates forms, validates inputs, creates NVS binaries, and executes flash operations:</p>
            <pre><code class="language-json">{
  "project": {
    "name": "My ESP32 Device",
    "version": "1.0.0"
  },
  "firmware": {
    "bootloader": { "file": "firmware/bootloader.bin", "address": "0x1000" },
    "app": { "file": "firmware/app.bin", "address": "0x10000" }
  },
  "nvs": {
    "address": "0x9000",
    "size": "0x6000",
    "namespace": "config",
    "fields": [
      { "key": "wifi_ssid", "label": "WiFi Network", "type": "string", "required": true },
      { "key": "wifi_password", "label": "WiFi Password", "type": "password", "required": true },
      { "key": "mqtt_broker", "label": "MQTT Broker", "type": "string", "default": "192.168.1.100" }
    ]
  }
}</code></pre>

            <p>Field additions automatically propagate to generated forms. Label modifications update interface elements. The template framework handles form generation, validation, and flash orchestration.</p>

            <h3>Generated Interface</h3>
            <p>Three-panel interface architecture: configuration panel, flash operations panel, device actions panel.</p>

            <div class="visual-box" style="padding: 32px; margin-left: -100px; margin-right: -100px; max-width: none;">
                <div style="display: grid; grid-template-columns: 1fr 1.2fr 1fr; gap: 24px;">
                    <!-- Panel 1: Configure -->
                    <div class="interface-panel">
                        <div class="panel-header">
                            <div class="panel-number">1</div>
                            <div class="panel-title">Configure</div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <div class="field-label">WiFi Network</div>
                            <div class="field-value">MyNetwork</div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <div class="field-label">WiFi Password</div>
                            <div class="field-value">••••••••</div>
                        </div>
                        <div>
                            <div class="field-label">MQTT Broker</div>
                            <div class="field-value">192.168.1.100</div>
                        </div>
                    </div>

                    <!-- Panel 2: Connect & Flash -->
                    <div class="interface-panel">
                        <div class="panel-header">
                            <div class="panel-number">2</div>
                            <div class="panel-title">Connect & Flash</div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <div class="field-label">Connection Status</div>
                            <div class="status-connected">
                                <div class="status-dot"></div>
                                <span class="status-text">Connected to COM3</span>
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <div class="field-label">Flashing Progress</div>
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: 65%;"></div>
                            </div>
                            <div class="progress-text">Flashing NVS partition... 65%</div>
                        </div>
                        <div class="button-group">
                            <div class="button-primary">Flash Device</div>
                            <div class="button-secondary">Reset</div>
                        </div>
                    </div>

                    <!-- Panel 3: Actions -->
                    <div class="interface-panel">
                        <div class="panel-header">
                            <div class="panel-number">3</div>
                            <div class="panel-title">Actions</div>
                        </div>
                        <div class="action-item">
                            <div class="action-title">Read Config</div>
                            <div class="action-description">Read current NVS from device</div>
                        </div>
                        <div class="action-item">
                            <div class="action-title">Erase NVS</div>
                            <div class="action-description">Clear all stored config</div>
                        </div>
                        <div class="action-item" style="margin-bottom: 0;">
                            <div class="action-title">Download Binary</div>
                            <div class="action-description">Save NVS partition as .bin</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="callout">
                <div class="callout-title">Demo</div>
                <div class="callout-body"><a href="/flasher/?project=active-wing">/flasher/?project=active-wing</a></div>
            </div>
        </div>


        <!-- Details -->
        <div id="details" class="lesson">
            <h2>Implementation Details</h2>
            <p class="lesson-intro">Namespace management, binary blob handling, partition sizing considerations, format limitations.</p>

            <h3>Multiple Namespace Support</h3>
            <p>Top-level object keys define separate namespaces. Namespace isolation allows key name collisions without conflict:</p>

            <pre><code class="language-javascript">const config = {
    wifi: { ssid: "MyNetwork", password: "SecurePass" },
    mqtt: { broker: "192.168.1.100", port: 1883 },
    calibration: { temp_offset: -2.5, enabled: true }
};

const nvs = generator.generate(config, 0x6000);</code></pre>

            <h3>Binary Blob Storage</h3>
            <p>Uint8Array values are encoded as blob entries. Blobs exceeding 8 bytes are chunked across multiple entries:</p>

            <pre><code class="language-javascript">const cert = await fetch('cert.pem').then(r => r.arrayBuffer());

const config = {
    security: {
        device_cert: new Uint8Array(cert),  // ~4KB maximum
        device_id: "ESP32-001"
    }
};

const nvs = generator.generate(config, 0x6000);</code></pre>

            <div class="callout">
                <div class="callout-title">Blob Size Limitations</div>
                <div class="callout-body">Maximum blob size in V1 format: approximately 4000 bytes. Constraint origin: 126 entries per page, uint8 span field. For data exceeding 4KB, alternative approaches include SPIFFS storage with NVS filename references.</div>
            </div>

            <h3>Partition Size Requirements</h3>
            <p>Partition sizes must be multiples of 4096 bytes. Larger partitions provide increased wear-leveling headroom at the cost of reduced usable flash capacity:</p>

            <div class="grid-2" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="card">
                    <h4>0x3000 (12KB)</h4>
                    <p>3 pages, ~30-40 pairs</p>
                </div>
                <div class="card">
                    <h4>0x6000 (24KB)</h4>
                    <p>6 pages, ~60-80 pairs</p>
                </div>
                <div class="card">
                    <h4>0x10000 (64KB)</h4>
                    <p>16 pages, ~160-200 pairs</p>
                </div>
            </div>
        </div>

        <!-- Links -->
        <div id="links" class="lesson">
            <h2>Links</h2>
            <ul>
                <li>Demo: <a href="/flasher/?project=active-wing">/flasher/?project=active-wing</a></li>
                <li>Template: <code>npx create-esp32-flasher</code></li>
                <li>ESP-IDF NVS: <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/storage/nvs_flash.html">docs.espressif.com</a></li>
                <li>Source: <a href="https://github.com/jctoledo/active_wing">github.com/jctoledo/active_wing</a></li>
            </ul>
        </div>
    </div>

    <script src="shared-nav.js"></script>
    <script>
        function wrapCodeBlocks(container) {
            const codeBlocks = container.querySelectorAll('pre[class*="language-"], pre:has(code[class*="language-"])');

            codeBlocks.forEach((pre) => {
                // Skip if already wrapped
                if (pre.parentElement.classList.contains('code-block-wrapper') || pre.closest('.code-block-wrapper')) {
                    return;
                }

                // Detect language from class name (check pre first, then code element inside)
                let classMatch = pre.className.match(/language-(\w+)/);
                if (!classMatch) {
                    const codeElement = pre.querySelector('code[class*="language-"]');
                    if (codeElement) {
                        classMatch = codeElement.className.match(/language-(\w+)/);
                    }
                }
                const language = classMatch ? classMatch[1] : 'code';

                // Check if this block should be collapsed by default
                const defaultCollapsed = pre.hasAttribute('data-collapsed');

                // Create wrapper structure
                const wrapper = document.createElement('div');
                wrapper.className = 'code-block-wrapper';
                if (defaultCollapsed) {
                    wrapper.classList.add('collapsed');
                }

                // Create header
                const header = document.createElement('div');
                header.className = 'code-block-header';

                // Create toggle with chevron SVG
                const toggle = document.createElement('div');
                toggle.className = 'code-block-toggle';
                toggle.innerHTML = `
                    <svg viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2.5 4.5L6 8L9.5 4.5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                `;

                // Create label
                const label = document.createElement('div');
                label.className = 'code-block-label';
                label.textContent = language;

                // Create content wrapper
                const content = document.createElement('div');
                content.className = 'code-block-content';

                // Build structure
                header.appendChild(toggle);
                header.appendChild(label);
                wrapper.appendChild(header);
                wrapper.appendChild(content);

                // Insert wrapper before pre and move pre into wrapper
                pre.parentNode.insertBefore(wrapper, pre);
                content.appendChild(pre);

                // Add click handler to entire header
                header.addEventListener('click', () => {
                    wrapper.classList.toggle('collapsed');
                });
            });
        }

        // Dark mode functionality
        function initDarkMode() {
            const savedMode = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedMode === 'dark' || (!savedMode && prefersDark)) {
                document.body.classList.add('dark-mode');
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark ? 'dark' : 'light');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize dark mode
            initDarkMode();

            // Wait for navbar to load, then attach toggle handler
            setTimeout(() => {
                const darkModeToggle = document.getElementById('dark-mode-toggle');
                if (darkModeToggle) {
                    darkModeToggle.addEventListener('click', toggleDarkMode);
                }
            }, 100);

            // Wrap all initially visible code blocks
            wrapCodeBlocks(document);
            Prism.highlightAll();
        });

        function showTab(tabName) {
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.style.display = 'none';
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
                btn.style.border = '1px solid transparent';
                btn.style.color = 'var(--text-secondary)';
                btn.style.boxShadow = 'none';
            });

            // Show selected tab
            const selectedTab = document.getElementById('tab-' + tabName);
            selectedTab.style.display = 'block';

            // Mark button as active
            event.target.classList.add('active');
            event.target.style.background = 'rgba(0,122,255,0.08)';
            event.target.style.border = '1px solid rgba(0,122,255,0.2)';
            event.target.style.color = '#007AFF';
            event.target.style.boxShadow = '0 1px 3px rgba(0,122,255,0.1), inset 0 1px 0 rgba(255,255,255,0.3)';

            // Wrap code blocks in the newly shown tab
            wrapCodeBlocks(selectedTab);

            // Re-highlight syntax
            Prism.highlightAll();
        }

        // Hex Visualizer Interactive Component
        const hexExamples = {
            'page-header': {
                title: 'Page Header (32 bytes)',
                bytes: [
                    0xFE, 0xFF, 0xFF, 0xFF,  // State (0xFFFFFFFE = active)
                    0x00, 0x00, 0x00, 0x00,  // Sequence number
                    0x01, 0x00, 0x00, 0x00,  // Version (0x01)
                    0xFF, 0xFF, 0xFF, 0xFF,  // Reserved
                    0xFF, 0xFF, 0xFF, 0xFF,  // Reserved
                    0xFF, 0xFF, 0xFF, 0xFF,  // Reserved
                    0xFF, 0xFF, 0xFF, 0xFF,  // Reserved
                    0x7E, 0x3A, 0x91, 0xC2   // CRC32
                ],
                fields: [
                    { range: [0, 3], type: 'field-state', name: 'State', value: '0xFFFFFFFE', desc: 'Page active state. 0xFFFFFFFE indicates this page is currently active and accepting writes.' },
                    { range: [4, 7], type: 'field-seq', name: 'Sequence', value: '0x00000000', desc: 'Sequence number for wear leveling. Increments with each page rotation cycle.' },
                    { range: [8, 11], type: 'field-version', name: 'Version', value: '0x00000001', desc: 'NVS format version. Version 1 is the current ESP-IDF standard.' },
                    { range: [12, 27], type: 'field-reserved', name: 'Reserved', value: '0xFF...', desc: 'Reserved bytes. Always 0xFF in V1 format for future compatibility.' },
                    { range: [28, 31], type: 'field-crc', name: 'CRC32', value: '0xC2913A7E', desc: 'CRC32 checksum of bytes 0-27. Validates page header integrity.' }
                ]
            },
            'u16-entry': {
                title: 'U16 Entry (port=1883)',
                bytes: [
                    0x01,                    // Namespace index (config)
                    0x02,                    // Type (U16)
                    0x01,                    // Span (1 entry)
                    0xFF,                    // Reserved
                    0x70, 0x6F, 0x72, 0x74,  // "port"
                    0x00, 0xFF, 0xFF, 0xFF,  // null terminator + padding
                    0xFF, 0xFF, 0xFF, 0xFF,  // padding
                    0xFF, 0xFF, 0xFF, 0xFF,  // padding
                    0x5B, 0x07,              // 1883 (0x075B little-endian)
                    0xFF, 0xFF,              // unused
                    0xFF, 0xFF, 0xFF, 0xFF,  // unused
                    0xFF, 0xFF, 0xFF, 0xFF   // unused
                ],
                fields: [
                    { range: [0, 0], type: 'field-namespace', name: 'NS Index', value: '0x01', desc: 'Namespace index. 0x01 refers to "config" namespace defined earlier in partition.' },
                    { range: [1, 1], type: 'field-type', name: 'Type', value: '0x02 (U16)', desc: 'Entry type 0x02 indicates unsigned 16-bit integer value.' },
                    { range: [2, 2], type: 'field-span', name: 'Span', value: '1', desc: 'Number of entries this item occupies. Single entry for U16.' },
                    { range: [3, 3], type: 'field-reserved', name: 'Reserved', value: '0xFF', desc: 'Reserved byte. Always 0xFF in current format.' },
                    { range: [4, 19], type: 'field-key', name: 'Key', value: '"port"', desc: 'Null-terminated ASCII key name. Remaining bytes padded with 0xFF.' },
                    { range: [20, 21], type: 'field-data', name: 'Value', value: '1883', desc: 'Little-endian U16: 0x075B = 1883. MQTT standard port.' },
                    { range: [22, 31], type: 'field-reserved', name: 'Unused', value: '0xFF...', desc: 'Unused data bytes. Filled with 0xFF.' }
                ]
            },
            'string-entry': {
                title: 'String Entry (ssid="HomeWiFi")',
                bytes: [
                    0x01,                    // Namespace index
                    0x21,                    // Type (STR)
                    0x01,                    // Span
                    0xFF,                    // Reserved
                    0x73, 0x73, 0x69, 0x64,  // "ssid"
                    0x00, 0xFF, 0xFF, 0xFF,  // null + padding
                    0xFF, 0xFF, 0xFF, 0xFF,  // padding
                    0xFF, 0xFF, 0xFF, 0xFF,  // padding
                    0x09, 0x00, 0x00, 0x00,  // Length: 9 bytes
                    0x48, 0x6F, 0x6D, 0x65,  // "Home"
                    0x57, 0x69, 0x46, 0x69   // "WiFi"
                ],
                fields: [
                    { range: [0, 0], type: 'field-namespace', name: 'NS Index', value: '0x01', desc: 'Namespace index referencing "config" namespace.' },
                    { range: [1, 1], type: 'field-type', name: 'Type', value: '0x21 (STR)', desc: 'Entry type 0x21 indicates null-terminated string value.' },
                    { range: [2, 2], type: 'field-span', name: 'Span', value: '1', desc: 'Span of 1. String fits in single entry (≤8 bytes).' },
                    { range: [3, 3], type: 'field-reserved', name: 'Reserved', value: '0xFF', desc: 'Reserved byte.' },
                    { range: [4, 19], type: 'field-key', name: 'Key', value: '"ssid"', desc: 'Key name "ssid" with null terminator and 0xFF padding.' },
                    { range: [20, 23], type: 'field-data', name: 'Length', value: '9', desc: 'String length in bytes (including null terminator).' },
                    { range: [24, 31], type: 'field-data', name: 'Data', value: '"HomeWiFi"', desc: 'String data: "HomeWiFi" (8 visible chars + null = 9 bytes).' }
                ]
            },
            'namespace': {
                title: 'Namespace Entry (define "config")',
                bytes: [
                    0x01,                    // Namespace index (self-reference)
                    0x00,                    // Type (namespace)
                    0x01,                    // Span
                    0xFF,                    // Reserved
                    0x63, 0x6F, 0x6E, 0x66,  // "conf"
                    0x69, 0x67, 0x00, 0xFF,  // "ig" + null + padding
                    0xFF, 0xFF, 0xFF, 0xFF,  // padding
                    0xFF, 0xFF, 0xFF, 0xFF,  // padding
                    0xFF, 0xFF, 0xFF, 0xFF,  // unused
                    0xFF, 0xFF, 0xFF, 0xFF,  // unused
                    0xFF, 0xFF, 0xFF, 0xFF,  // unused
                    0xFF, 0xFF, 0xFF, 0xFF   // unused
                ],
                fields: [
                    { range: [0, 0], type: 'field-namespace', name: 'NS Index', value: '0x01', desc: 'Namespace index. Namespaces assign themselves an index (0x01 in this case).' },
                    { range: [1, 1], type: 'field-type', name: 'Type', value: '0x00 (NS)', desc: 'Type 0x00 defines a new namespace. Not a data entry.' },
                    { range: [2, 2], type: 'field-span', name: 'Span', value: '1', desc: 'Namespace definitions occupy one entry.' },
                    { range: [3, 3], type: 'field-reserved', name: 'Reserved', value: '0xFF', desc: 'Reserved byte.' },
                    { range: [4, 19], type: 'field-key', name: 'NS Name', value: '"config"', desc: 'Namespace name "config". All subsequent entries with ns_index=0x01 belong to this namespace.' },
                    { range: [20, 31], type: 'field-reserved', name: 'Unused', value: '0xFF...', desc: 'Unused bytes. Namespace entries don\'t store data values.' }
                ]
            }
        };

        function initHexVisualizer() {
            const container = document.getElementById('hex-bytes-container');
            const infoPanel = document.getElementById('hex-info-panel');
            const tabs = document.querySelectorAll('.hex-tab');

            let currentExample = 'page-header';
            let activeByteIndex = null;

            function renderHexBytes(exampleKey) {
                const example = hexExamples[exampleKey];
                container.innerHTML = '';

                example.bytes.forEach((byte, index) => {
                    const byteEl = document.createElement('div');
                    byteEl.className = 'hex-byte';
                    byteEl.textContent = byte.toString(16).toUpperCase().padStart(2, '0');
                    byteEl.dataset.index = index;

                    // Find which field this byte belongs to
                    const field = example.fields.find(f => index >= f.range[0] && index <= f.range[1]);
                    if (field) {
                        byteEl.classList.add(field.type);
                    }

                    byteEl.addEventListener('mouseenter', () => showByteInfo(index, exampleKey));
                    byteEl.addEventListener('mouseleave', () => hideByteInfo());
                    byteEl.addEventListener('click', () => toggleByteActive(index));

                    container.appendChild(byteEl);
                });
            }

            function showByteInfo(index, exampleKey) {
                const example = hexExamples[exampleKey];
                const field = example.fields.find(f => index >= f.range[0] && index <= f.range[1]);

                if (!field) return;

                // Highlight all bytes in this field
                document.querySelectorAll('.hex-byte').forEach((el, i) => {
                    if (i >= field.range[0] && i <= field.range[1]) {
                        el.classList.add('active');
                    } else {
                        el.classList.remove('active');
                    }
                });

                // Show info panel
                const rangeStart = '0x' + field.range[0].toString(16).toUpperCase().padStart(2, '0');
                const rangeEnd = '0x' + field.range[1].toString(16).toUpperCase().padStart(2, '0');
                const rangeStr = field.range[0] === field.range[1] ? rangeStart : `${rangeStart}-${rangeEnd}`;

                const bytes = example.bytes.slice(field.range[0], field.range[1] + 1);
                const hexStr = bytes.map(b => b.toString(16).toUpperCase().padStart(2, '0')).join(' ');

                infoPanel.innerHTML = `
                    <div class="hex-info-content">
                        <div class="hex-info-field">Field</div>
                        <div class="hex-info-value">${field.name}</div>

                        <div class="hex-info-field">Byte Range</div>
                        <div class="hex-info-range">${rangeStr}</div>

                        <div class="hex-info-field">Value</div>
                        <div class="hex-info-value">${field.value}</div>

                        <div class="hex-info-desc">${field.desc}</div>

                        <div class="hex-info-bytes">
                            <div class="hex-info-bytes-label">Raw Hex</div>
                            <div class="hex-info-bytes-value">${hexStr}</div>
                        </div>
                    </div>
                `;
            }

            function hideByteInfo() {
                if (activeByteIndex === null) {
                    document.querySelectorAll('.hex-byte').forEach(el => el.classList.remove('active'));
                    infoPanel.innerHTML = `
                        <div class="hex-info-empty">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="16" cy="16" r="14"/>
                                <path d="M16 12v8M16 22v2"/>
                            </svg>
                            <p>Hover over bytes to see details</p>
                        </div>
                    `;
                }
            }

            function toggleByteActive(index) {
                if (activeByteIndex === index) {
                    activeByteIndex = null;
                    hideByteInfo();
                } else {
                    activeByteIndex = index;
                }
            }

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    const exampleKey = tab.dataset.example;
                    currentExample = exampleKey;
                    activeByteIndex = null;
                    renderHexBytes(exampleKey);
                    hideByteInfo();
                });
            });

            // Initial render
            renderHexBytes(currentExample);
        }

        // Initialize hex visualizer when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('hex-bytes-container')) {
                initHexVisualizer();
            }
        });

        // Installation tab switcher
        function showInstallTab(tab) {
            // Hide all install panes
            document.querySelectorAll('.install-pane').forEach(pane => {
                pane.style.display = 'none';
            });

            // Remove active from all buttons
            document.querySelectorAll('.install-tab-btn').forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.border = '1px solid var(--border-color)';
                btn.style.color = 'var(--text-secondary)';
            });

            // Show selected pane
            document.getElementById('install-' + tab).style.display = 'block';

            // Mark button as active
            event.target.style.background = 'rgba(0,122,255,0.1)';
            event.target.style.border = '1px solid rgba(0,122,255,0.3)';
            event.target.style.color = '#007AFF';

            // Re-highlight syntax
            Prism.highlightAll();
        }
    </script>
</body>
</html>
