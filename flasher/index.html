<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Web Flasher</title>
    <link rel="stylesheet" href="../shared-styles.css">
    <script>
        // Apply dark mode immediately to prevent flash
        (function() {
            const savedMode = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedMode === 'dark' || (!savedMode && prefersDark)) {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
    <style>
        /* Flasher-specific styles only */
        body.dev-panel-open {
            overflow: hidden;
        }

        /* Main layout: Starts centered, transitions to 3 columns */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 48px 80px 48px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 40px;
            align-items: start;
        }

        .main-content.expanded {
            grid-template-columns: 380px 1fr 420px;
        }

        /* Left panel: Config */
        .left-panel {
            background: transparent;
            padding: 0;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: opacity 0.001s, max-height 0.001s;
        }

        .main-content.expanded .left-panel {
            opacity: 1;
            max-height: none;
            position: sticky;
            top: 100px;
        }

        /* Center panel: Info */
        .center-panel {
            background: transparent;
            padding: 0;
            max-width: 600px;
            margin: 0 auto;
            justify-self: center;
        }

        .main-content.expanded .center-panel {
            max-width: none;
            margin: 0;
            justify-self: stretch;
        }

        /* Header stays centered initially, content below aligns left when expanded */
        .center-panel-header {
            text-align: center;
            opacity: 1;
            overflow: hidden;
        }

        .main-content.expanded .center-panel-header {
            display: none;
        }

        .center-panel-content {
            text-align: left;
        }

        /* Right panel: Actions */
        .right-panel {
            background: transparent;
            padding: 0;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
        }

        .main-content.expanded .right-panel {
            opacity: 1;
            max-height: none;
            position: sticky;
            top: 100px;
        }

        h1 {
            font-size: 56px;
            color: #1d1d1f;
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: -0.015em;
        }

        .main-content.expanded h1 {
            font-size: 40px;
        }

        .subtitle {
            font-size: 21px;
            color: #6e6e73;
            margin-bottom: 56px;
            font-weight: 400;
            letter-spacing: 0.011em;
        }

        /* Initial project selector in center */
        .initial-selector {
            max-width: 400px;
            margin: 60px auto 0;
            opacity: 1;
            text-align: center;
        }

        .main-content.expanded .initial-selector {
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            margin: 0;
        }

        /* Project details fade in */
        #project-details {
            opacity: 0;
        }

        #project-details.active {
            opacity: 1;
        }

        h2 {
            font-size: 32px;
            color: #1d1d1f;
            margin-top: 56px;
            margin-bottom: 24px;
            font-weight: 600;
            letter-spacing: -0.012em;
        }

        h2:first-of-type {
            margin-top: 0;
        }

        /* Panel headers with step badges */
        .panel-header {
            font-size: 28px;
            color: #1d1d1f;
            margin-top: 0;
            margin-bottom: 40px;
            font-weight: 600;
            letter-spacing: -0.012em;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .step-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #1d1d1f;
            color: white;
            border-radius: 50%;
            font-size: 15px;
            font-weight: 600;
            flex-shrink: 0;
        }

        h3 {
            font-size: 12px;
            color: #86868b;
            margin-bottom: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        /* Form styling */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .config-group .form-group {
            margin-bottom: 16px;
        }

        .config-group .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 17px;
            font-weight: 400;
            color: #1d1d1f;
            margin-bottom: 10px;
            letter-spacing: -0.022em;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.12);
            border-radius: 8px;
            font-size: 17px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: #ffffff;
            color: #1d1d1f;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #0071e3;
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
        }

        input[type="text"]:invalid:not(:placeholder-shown),
        input[type="password"]:invalid:not(:placeholder-shown),
        input[type="number"]:invalid:not(:placeholder-shown) {
            border-color: #ff3b30;
        }

        input[type="text"]:invalid:focus:not(:placeholder-shown),
        input[type="password"]:invalid:focus:not(:placeholder-shown),
        input[type="number"]:invalid:focus:not(:placeholder-shown) {
            box-shadow: 0 0 0 4px rgba(255, 59, 48, 0.1);
        }

        input::placeholder {
            color: #86868b;
        }

        .help-text {
            font-size: 14px;
            color: #86868b;
            margin-top: 6px;
            display: block;
            line-height: 1.47059;
            letter-spacing: -0.016em;
        }

        .config-group {
            margin-bottom: 48px;
            padding: 32px;
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .config-group:last-child {
            margin-bottom: 0;
        }

        .config-group h3 {
            margin: 0 0 24px 0;
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .config-group .help-text {
            margin-bottom: 24px;
            color: #86868b;
            font-size: 14px;
            text-transform: none;
            letter-spacing: -0.016em;
            font-weight: 400;
        }

        /* Sections */
        .section {
            margin-bottom: 24px;
            background: transparent;
            border-radius: 0;
            padding: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .section:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .section.section-bg {
            background: #ffffff;
            padding: 32px;
            border-radius: 16px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .section h3 {
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            margin-bottom: 20px;
            margin-top: 0;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .requirement-list, .instruction-list {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        .requirement-list li, .instruction-list li {
            font-size: 17px;
            color: #1d1d1f;
            line-height: 1.47059;
            padding: 12px 0;
            padding-left: 36px;
            position: relative;
            letter-spacing: -0.022em;
        }

        .requirement-list li::before {
            content: '✓';
            position: absolute;
            left: 0;
            width: 24px;
            height: 24px;
            background: #0071e3;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-size: 13px;
            font-weight: 600;
        }

        .instruction-list li::before {
            content: attr(data-step);
            position: absolute;
            left: 0;
            width: 24px;
            height: 24px;
            background: transparent;
            color: #0071e3;
            border: 2px solid #0071e3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        /* Documentation link */
        .doc-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding: 14px 24px;
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            text-decoration: none;
            color: #0071e3;
            font-size: 17px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.28, 0.11, 0.32, 1);
            letter-spacing: -0.022em;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .doc-link:hover {
            border-color: #0071e3;
            background: #f5f5f7;
            box-shadow: 0 2px 8px rgba(0, 113, 227, 0.12);
        }

        .doc-link .external-icon {
            font-size: 16px;
            opacity: 0.7;
        }

        /* Collapsible sections (for config panels) */
        .collapsible-section {
            margin-bottom: 24px;
            border: none;
            border-radius: 0;
            overflow: visible;
        }

        .section-header {
            background: transparent;
            padding: 16px 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            border-bottom: 1px solid #f5f5f5;
        }

        .section-header:hover {
            background: transparent;
        }

        .section-header h3 {
            margin: 0;
            font-size: 11px;
            font-weight: 600;
            color: #5c5e62;
            text-transform: uppercase;
            letter-spacing: 1.2px;
        }

        .section-toggle {
            font-size: 8px;
            transition: transform 0.2s;
            color: #8a8a8a;
        }

        .section-header.collapsed .section-toggle {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 20px 0;
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .section-content.collapsed {
            max-height: 0;
            padding: 0;
        }

        /* Progress bar */
        .progress-container {
            margin-bottom: 24px;
            display: none;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(0, 0, 0, 0.06);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #0071e3;
            transition: width 0.3s cubic-bezier(0.28, 0.11, 0.32, 1);
            width: 0%;
            border-radius: 2px;
        }

        .progress-text {
            font-size: 13px;
            color: #86868b;
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            letter-spacing: -0.016em;
            font-variant-numeric: tabular-nums;
        }

        /* Status box */
        .status-box {
            background: #f5f5f7;
            border: none;
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
            text-align: left;
            transition: all 0.3s cubic-bezier(0.28, 0.11, 0.32, 1);
        }

        .status-box.waiting {
            background: #f5f5f7;
        }

        .status-box.connected {
            background: rgba(0, 113, 227, 0.08);
            border: 1px solid rgba(0, 113, 227, 0.2);
        }

        .status-box.flashing {
            background: rgba(255, 149, 0, 0.08);
            border: 1px solid rgba(255, 149, 0, 0.2);
        }

        .status-box.error {
            background: rgba(255, 59, 48, 0.08);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        .status-box.success {
            background: rgba(52, 199, 89, 0.08);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .status-text {
            font-size: 17px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 6px;
            letter-spacing: -0.022em;
        }

        .status-subtext {
            font-size: 15px;
            color: #86868b;
            line-height: 1.47059;
            letter-spacing: -0.016em;
        }

        /* Chip info box */
        .chip-info {
            background: #f5f5f7;
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
            display: none;
        }

        .chip-info.active {
            display: block;
        }

        .chip-info-row {
            display: flex;
            justify-content: space-between;
            font-size: 15px;
            margin-bottom: 10px;
            line-height: 1.47059;
        }

        .chip-info-row:last-child {
            margin-bottom: 0;
        }

        .chip-info-label {
            color: #86868b;
            font-weight: 400;
            letter-spacing: -0.016em;
        }

        .chip-info-value {
            font-weight: 500;
            color: #1d1d1f;
            letter-spacing: -0.016em;
            font-variant-numeric: tabular-nums;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 15px 28px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.28, 0.11, 0.32, 1);
            margin-bottom: 12px;
            letter-spacing: -0.022em;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: #0071e3;
            color: white;
            box-shadow: 0 1px 3px rgba(0, 113, 227, 0.12);
        }

        .btn-primary:hover:not(:disabled) {
            background: #0077ed;
            box-shadow: 0 2px 8px rgba(0, 113, 227, 0.2);
        }

        .btn-success {
            background: #0071e3;
            color: white;
            box-shadow: 0 1px 3px rgba(0, 113, 227, 0.12);
        }

        .btn-success:hover:not(:disabled) {
            background: #0077ed;
            box-shadow: 0 2px 8px rgba(0, 113, 227, 0.2);
        }

        .btn-danger {
            background: #0071e3;
            color: white;
            box-shadow: 0 1px 3px rgba(0, 113, 227, 0.12);
        }

        .btn-danger:hover:not(:disabled) {
            background: #0077ed;
            box-shadow: 0 2px 8px rgba(0, 113, 227, 0.2);
        }

        .btn-secondary {
            background: #f5f5f7;
            color: #1d1d1f;
            border: none;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e8e8ed;
        }

        .btn:disabled {
            opacity: 0.32;
            cursor: not-allowed;
        }

        .btn:active:not(:disabled) {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        /* Serial monitor */
        .serial-monitor {
            background: #ffffff;
            color: #1d1d1f;
            border-radius: 0;
            padding: 16px 24px;
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            flex: 1;
            overflow-y: auto;
            line-height: 1.6;
            border: none;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .serial-monitor::-webkit-scrollbar {
            width: 8px;
        }

        .serial-monitor::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.02);
        }

        .serial-monitor::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        .serial-monitor::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.15);
        }

        .serial-line {
            margin-bottom: 4px;
            font-variant-numeric: tabular-nums;
        }

        .serial-line.info {
            color: #4fc3f7;
        }

        .serial-line.success {
            color: #34c759;
        }

        .serial-line.error {
            color: #ff3b30;
        }

        .serial-line.warning {
            color: #ff9500;
        }

        .dev-console-toolbar {
            padding: 12px 24px;
            background: #ffffff;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .dev-console-toolbar .btn {
            font-size: 13px;
            padding: 8px 16px;
            margin: 0;
        }

        .troubleshooting-section {
            margin-top: 32px;
        }

        .troubleshooting-toggle {
            width: 100%;
            text-align: left;
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 16px;
            color: #1d1d1f;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            letter-spacing: -0.016em;
            transition: all 0.2s cubic-bezier(0.28, 0.11, 0.32, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .troubleshooting-toggle:hover {
            background: #f5f5f7;
            border-color: rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .troubleshooting-toggle:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        .troubleshooting-toggle .toggle-arrow {
            font-size: 10px;
            transition: transform 0.2s cubic-bezier(0.28, 0.11, 0.32, 1);
            color: #86868b;
        }

        .troubleshooting-toggle.collapsed .toggle-arrow {
            transform: rotate(-90deg);
        }

        .troubleshooting {
            background: #ffffff;
            border-radius: 0 0 16px 16px;
            border-left: 1px solid rgba(0, 0, 0, 0.06);
            border-right: 1px solid rgba(0, 0, 0, 0.06);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            border-top: none;
            padding: 0 24px;
            margin-top: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.28, 0.11, 0.32, 1), padding 0.3s cubic-bezier(0.28, 0.11, 0.32, 1);
        }

        .troubleshooting.active {
            max-height: 500px;
            padding: 0 24px 24px 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .troubleshooting-toggle:not(.collapsed) {
            border-radius: 16px 16px 0 0;
            border-bottom: none;
            box-shadow: none;
        }

        .troubleshooting p {
            font-size: 15px;
            color: #1d1d1f;
            line-height: 1.47059;
            margin-bottom: 16px;
            padding-top: 12px;
            letter-spacing: -0.016em;
        }

        .troubleshooting p:first-child {
            padding-top: 16px;
        }

        .troubleshooting p:last-child {
            margin-bottom: 0;
        }

        .troubleshooting p strong {
            font-weight: 600;
            color: #1d1d1f;
        }

        /* Links section */
        .links-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .link-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            text-decoration: none;
            color: #1d1d1f;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.28, 0.11, 0.32, 1);
            letter-spacing: -0.016em;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .link-btn:hover {
            background: #f5f5f7;
            border-color: rgba(0, 0, 0, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .link-btn:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-content,
            .main-content.expanded {
                grid-template-columns: 1fr;
                gap: 40px;
            }

            .left-panel,
            .right-panel,
            .main-content.expanded .left-panel,
            .main-content.expanded .right-panel {
                position: static;
                opacity: 1;
                transform: none;
                max-height: none;
                overflow: visible;
            }

            .center-panel,
            .main-content.expanded .center-panel {
                max-width: none;
            }

            .center-panel-header,
            .main-content.expanded .center-panel-header {
                text-align: left;
            }

            h1,
            .main-content.expanded h1 {
                font-size: 32px;
            }
        }

        /* Saved indicator */
        .saved-indicator {
            display: inline-block;
            font-size: 13px;
            color: #34c759;
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.3s cubic-bezier(0.28, 0.11, 0.32, 1);
            letter-spacing: -0.016em;
        }

        .saved-indicator.show {
            opacity: 1;
        }

        /* Tab navigation */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .tab {
            padding: 10px 16px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 15px;
            font-weight: 500;
            color: #86868b;
            cursor: pointer;
            margin-bottom: -1px;
            transition: all 0.2s cubic-bezier(0.28, 0.11, 0.32, 1);
            letter-spacing: -0.016em;
        }

        .tab:hover {
            color: #1d1d1f;
        }

        .tab.active {
            color: #0071e3;
            border-bottom-color: #0071e3;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Developer Options */
        .dev-options-section {
            margin-bottom: 32px;
        }

        .dev-options-toggle {
            width: 100%;
            text-align: left;
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            color: #1d1d1f;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s cubic-bezier(0.28, 0.11, 0.32, 1);
            letter-spacing: -0.016em;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .dev-options-toggle:hover {
            background: #f5f5f7;
            border-color: rgba(0, 0, 0, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .dev-options-toggle:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        .dev-options-toggle .toggle-arrow {
            font-size: 10px;
            transition: transform 0.2s cubic-bezier(0.28, 0.11, 0.32, 1);
            color: #86868b;
        }

        .dev-options-toggle.collapsed .toggle-arrow {
            transform: rotate(-90deg);
        }

        /* Developer Options - Side Panel Drawer */
        .dev-panel-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1400;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.28, 0.11, 0.32, 1);
        }

        .dev-panel-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        .dev-options-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 800px;
            max-width: 90vw;
            background: #ffffff;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
            z-index: 1500;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.28, 0.11, 0.32, 1);
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(0, 0, 0, 0.1);
        }

        .dev-options-panel.active {
            transform: translateX(0);
        }

        /* Toggle button styles updated */
        .dev-options-toggle.active {
            background: #0071e3;
            color: white;
            border-color: #0071e3;
        }

        .dev-options-toggle.active:hover {
            background: #0077ed;
            border-color: #0077ed;
        }

        .dev-options-toggle.active .dev-arrow {
            transform: rotate(180deg);
        }

        .dev-arrow {
            transition: transform 0.3s cubic-bezier(0.28, 0.11, 0.32, 1);
        }

        .dev-options-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            background: #ffffff;
        }

        .dev-options-title {
            font-size: 20px;
            font-weight: 600;
            color: #1d1d1f;
            letter-spacing: -0.012em;
            margin: 0;
        }

        .dev-options-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .dev-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f5f5f7;
            border: none;
            color: #1d1d1f;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.28, 0.11, 0.32, 1);
        }

        .dev-action-btn:hover {
            background: #e8e8ed;
        }

        .dev-action-btn:active {
            transform: scale(0.9);
        }

        .dev-options-body {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }

        .dev-tabs {
            display: flex;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background: #ffffff;
            padding: 0 24px;
            flex-shrink: 0;
        }

        .dev-tab {
            padding: 12px 0;
            margin-right: 32px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #86868b;
            border-bottom: 2px solid transparent;
            transition: all 0.2s cubic-bezier(0.28, 0.11, 0.32, 1);
            letter-spacing: -0.016em;
        }

        .dev-tab:hover {
            color: #1d1d1f;
        }

        .dev-tab.active {
            color: #0071e3;
            border-bottom-color: #0071e3;
        }

        .dev-tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .dev-tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .dev-tab-content[data-tab="settings"] {
            padding: 24px;
        }

        .dev-tab-content[data-tab="console"] {
            padding: 0;
            background: #ffffff;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 15px;
            color: #1d1d1f;
            font-weight: 400;
            letter-spacing: -0.016em;
            line-height: 1.47059;
        }

        .radio-label input[type="radio"] {
            margin-right: 12px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: #0071e3;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 15px;
            color: #1d1d1f;
            font-weight: 400;
            margin-bottom: 12px;
            letter-spacing: -0.016em;
            line-height: 1.47059;
        }

        .checkbox-label:last-child {
            margin-bottom: 0;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 12px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: #0071e3;
        }

        input[type="file"] {
            font-size: 15px;
            padding: 12px 16px;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.12);
            border-radius: 8px;
            background: #ffffff;
            color: #1d1d1f;
            letter-spacing: -0.016em;
        }

        input[type="file"]::-webkit-file-upload-button {
            padding: 8px 16px;
            border: none;
            background: #f5f5f7;
            color: #1d1d1f;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            margin-right: 12px;
            letter-spacing: -0.016em;
            transition: all 0.2s cubic-bezier(0.28, 0.11, 0.32, 1);
        }

        input[type="file"]::-webkit-file-upload-button:hover {
            background: #e8e8ed;
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>

    <div class="main-content expanded" id="main-content">
        <!-- Left Panel: Instructions -->
        <div class="left-panel">
            <div class="panel-header">
                <span class="step-badge">1</span>
                Instructions
            </div>
            <div id="project-details">
                <!-- Populated dynamically -->
            </div>

            <!-- Troubleshooting -->
            <div class="troubleshooting-section">
                <button class="troubleshooting-toggle collapsed" id="troubleshooting-toggle">
                    <span>Troubleshooting</span>
                    <span class="toggle-arrow">▼</span>
                </button>
                <div class="troubleshooting" id="troubleshooting-content">
                    <p><strong>Device not detected:</strong> Try holding the BOOT button while connecting the USB cable, then release after connection.</p>
                    <p><strong>Connection lost during flash:</strong> Try using a different USB cable or port. USB 3.0 ports are recommended for stability.</p>
                    <p><strong>Permission denied:</strong> Ensure no other program is using the serial port (Arduino IDE, PlatformIO, serial monitors, etc.).</p>
                    <p><strong>Browser not supported:</strong> Use Chrome, Edge, or Opera browser for web flashing support.</p>
                </div>
            </div>
        </div>

        <!-- Center Panel: Project Selector & Configuration -->
        <div class="center-panel">
            <div class="center-panel-header">
                <h1>ESP32 Web Flasher</h1>
                <p class="subtitle">Flash firmware directly from your browser. Built on <a href="https://espressif.github.io/esptool-js/" target="_blank" style="color: #0071e3; text-decoration: none;">esptool-js</a>.</p>
            </div>

            <div class="center-panel-content">
                <div id="config-section">
                    <div class="panel-header">
                        <span class="step-badge">2</span>
                        Configuration
                    </div>

                    <!-- Dynamic config sections will be inserted here -->
                    <div id="config-container"></div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Status & Controls -->
        <div class="right-panel">
            <div class="panel-header">
                <span class="step-badge">3</span>
                Status
            </div>

            <!-- Browser compatibility check -->
            <div class="status-box error" id="browser-check" style="display: none;">
                <div class="status-text">Browser not supported</div>
                <div class="status-subtext">Please use Chrome, Edge, or Opera</div>
            </div>

            <!-- Main status -->
            <div class="status-box waiting" id="status-box">
                <div class="status-text">Ready</div>
                <div class="status-subtext">Configure settings, then connect your device</div>
            </div>

            <!-- Chip info (shown after connection) -->
            <div class="chip-info" id="chip-info">
                <div class="chip-info-row">
                    <span class="chip-info-label">Chip:</span>
                    <span class="chip-info-value" id="chip-type">-</span>
                </div>
                <div class="chip-info-row">
                    <span class="chip-info-label">MAC Address:</span>
                    <span class="chip-info-value" id="chip-mac">-</span>
                </div>
            </div>

            <!-- Progress bar -->
            <div class="progress-container" id="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text">
                    <span id="progress-percent">0%</span>
                    <span id="progress-time">Estimating...</span>
                </div>
            </div>

            <!-- Main Actions -->
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" id="btn-connect" style="margin-bottom: 12px;">Connect Device</button>
                <button class="btn btn-success" id="btn-flash" disabled style="display: none; margin-bottom: 12px;">Flash Firmware</button>
                <button class="btn btn-secondary" id="btn-write-config" disabled style="margin-bottom: 12px; background: white; border: 1px solid rgba(0,0,0,0.15);">Write Config</button>
            </div>

            <!-- Developer Options Button -->
            <div class="dev-options-section">
                <button class="dev-options-toggle" id="dev-mode-toggle">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">⚙</span>
                        <span>Developer Options</span>
                    </span>
                    <span class="dev-arrow" style="font-size: 16px; opacity: 0.6;">→</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Developer Options Side Panel -->
    <div class="dev-panel-backdrop" id="dev-panel-backdrop"></div>
    <div class="dev-options-panel" id="dev-options-panel">
        <div class="dev-options-header">
            <h2 class="dev-options-title">Developer Options</h2>
            <div class="dev-options-actions">
                <button class="dev-action-btn" id="dev-options-close" aria-label="Close" title="Close">×</button>
            </div>
        </div>
            <div class="dev-options-body">
                <!-- Tabs -->
                <div class="dev-tabs">
                    <button class="dev-tab active" data-tab="settings">Settings</button>
                    <button class="dev-tab" data-tab="console">Console</button>
                </div>

                <!-- Settings Tab -->
                <div class="dev-tab-content active" data-tab="settings">
                    <div class="form-group">
                        <label>Firmware Source</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="firmware-source" value="release" checked id="dev-source-release">
                                <span>Download from release</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="firmware-source" value="custom" id="dev-source-custom">
                                <span>Upload custom .bin file</span>
                            </label>
                        </div>
                    </div>

                    <div id="release-options" class="form-group">
                        <label for="dev-version">Version</label>
                        <select id="dev-version">
                            <option value="latest" selected>Latest (recommended)</option>
                        </select>
                    </div>

                    <div id="custom-options" class="form-group" style="display: none;">
                        <label for="dev-custom-file">Firmware file</label>
                        <input type="file" id="dev-custom-file" accept=".bin">
                        <span class="help-text" id="custom-file-info"></span>
                    </div>

                    <div class="form-group">
                        <label for="dev-baudrate">Baudrate</label>
                        <select id="dev-baudrate">
                            <option value="115200" selected>115200 (Auto-detect)</option>
                            <option value="230400">230400</option>
                            <option value="460800">460800</option>
                            <option value="921600">921600</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="dev-enable-tracing">
                            <span>Enable verbose tracing</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="dev-skip-chip-check">
                            <span>Skip chip validation</span>
                        </label>
                    </div>
                </div>

                <!-- Console Tab -->
                <div class="dev-tab-content" data-tab="console">
                    <div class="serial-monitor" id="serial-monitor">
                        <div class="serial-line info">Ready to flash. Configure settings and connect your device.</div>
                    </div>
                    <div class="dev-console-toolbar">
                        <button class="btn btn-secondary" id="btn-clear-monitor">Clear Console</button>
                        <button class="btn btn-secondary" id="btn-export-log">Export Log</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="dev-panel-backdrop" id="about-backdrop"></div>
    <div class="dev-options-panel" id="about-panel">
        <div class="dev-options-header">
            <h2 class="dev-options-title">About This Flasher</h2>
            <div class="dev-options-actions">
                <button class="dev-action-btn" id="about-close" aria-label="Close" title="Close">×</button>
            </div>
        </div>
        <div class="dev-options-body" style="padding: 48px 40px; overflow-y: auto;">
            <p style="font-size: 32px; color: #1d1d1f; line-height: 1.125; margin-bottom: 16px; font-weight: 600; letter-spacing: -0.015em;">
                Distribute firmware, without the toolchain.
            </p>
            <p style="font-size: 19px; color: #6e6e73; line-height: 1.42; margin-bottom: 56px; font-weight: 400; letter-spacing: 0.012em;">
                Generate NVS partitions in JavaScript. Flash pre-compiled firmware with runtime configuration. No toolchain installation required.
            </p>

            <div style="margin-bottom: 72px;">
                <h3 style="font-size: 12px; color: #86868b; margin-bottom: 20px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em;">The problem</h3>
                <p style="font-size: 15px; color: #1d1d1f; line-height: 1.6; margin-bottom: 24px; letter-spacing: -0.016em;">
                    Traditionally, ESP32 configuration requires hardcoding values in firmware or manually creating NVS partition CSVs, running <code style="background: #f5f5f7; padding: 2px 6px; border-radius: 4px; font-family: 'SF Mono', Monaco, monospace; font-size: 13px;">nvs_partition_gen.py</code>, and flashing with esptool. Users need Python, ESP-IDF, and must recompile for every config change.
                </p>
                <p style="font-size: 15px; color: #1d1d1f; line-height: 1.6; margin-bottom: 24px; letter-spacing: -0.016em;">
                    This flasher generates ESP-IDF NVS partition binaries <strong>in the browser</strong> and flashes them alongside pre-compiled firmware. Users enter WiFi credentials, MQTT brokers, API endpoints, sensor calibration, PID parameters, or runtime config via web forms. The flasher generates NVS binary, validates chip type, downloads firmware from GitHub releases, and flashes both (firmware at 0x0, NVS at 0x9000) using Web Serial API.
                </p>
                <p style="font-size: 15px; color: #1d1d1f; line-height: 1.6; letter-spacing: -0.016em;">
                    Includes error handling, progress indicators, serial monitoring, chip validation with override, custom firmware upload, and localStorage persistence. Client-side only—no backend, no network transmission of credentials.
                </p>
            </div>

            <div style="margin-bottom: 72px;">
                <h3 style="font-size: 12px; color: #86868b; margin-bottom: 20px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em;">How it works</h3>
                <div style="display: grid; gap: 24px;">
                    <div>
                        <div style="font-size: 17px; color: #1d1d1f; font-weight: 500; margin-bottom: 4px; letter-spacing: -0.022em;">1. Define your config schema</div>
                        <div style="font-size: 15px; color: #6e6e73; line-height: 1.47; letter-spacing: -0.016em; margin-bottom: 12px;">Create <code style="background: #f5f5f7; padding: 2px 6px; border-radius: 4px; font-family: 'SF Mono', Monaco, monospace; font-size: 13px;">project.json</code> with field definitions. Forms auto-generate.</div>
                        <pre style="background: #1d1d1f; color: #f5f5f7; padding: 16px; border-radius: 8px; overflow-x: auto; font-family: 'SF Mono', Monaco, monospace; font-size: 13px; line-height: 1.5; margin: 0;">
{
  "configSections": [{
    "id": "wifi",
    "fields": [{
      "id": "ssid",
      "nvsKey": "wifi_ssid",
      "type": "text"
    }]
  }]
}</pre>
                    </div>
                    <div>
                        <div style="font-size: 17px; color: #1d1d1f; font-weight: 500; margin-bottom: 4px; letter-spacing: -0.022em;">2. NVS binary generation</div>
                        <div style="font-size: 15px; color: #6e6e73; line-height: 1.47; letter-spacing: -0.016em; margin-bottom: 12px;">User enters values. JavaScript generates valid ESP-IDF NVS partition with proper page headers, entry structures, and CRC32 checksums.</div>
                        <pre style="background: #1d1d1f; color: #f5f5f7; padding: 16px; border-radius: 8px; overflow-x: auto; font-family: 'SF Mono', Monaco, monospace; font-size: 13px; line-height: 1.5; margin: 0;">
// 4KB pages, 32-byte entries
// Page header: state, seq, version
// Entries: namespace, type, span, key, data
// CRC32 over entry metadata
const binary = generator.generate({
  config: { wifi_ssid: "MyNetwork" }
}, 0x6000);  // 24KB partition</pre>
                    </div>
                    <div>
                        <div style="font-size: 17px; color: #1d1d1f; font-weight: 500; margin-bottom: 4px; letter-spacing: -0.022em;">3. Read from firmware</div>
                        <div style="font-size: 15px; color: #6e6e73; line-height: 1.47; letter-spacing: -0.016em; margin-bottom: 12px;">Standard ESP-IDF NVS API. Works with Rust, C, Arduino.</div>
                        <pre style="background: #1d1d1f; color: #f5f5f7; padding: 16px; border-radius: 8px; overflow-x: auto; font-family: 'SF Mono', Monaco, monospace; font-size: 13px; line-height: 1.5; margin: 0;">
// Rust (esp-idf-svc)
let nvs = EspNvs::new(partition, "config", true)?;
let mut ssid = String::new();
nvs.get_str("wifi_ssid", &amp;mut ssid)?;</pre>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 72px;">
                <h3 style="font-size: 12px; color: #86868b; margin-bottom: 20px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em;">Implementation</h3>
                <div style="display: grid; gap: 16px;">
                    <div style="font-size: 15px; color: #1d1d1f; line-height: 1.47; letter-spacing: -0.016em;">
                        <strong>NVS Format:</strong> Full ESP-IDF NVS binary format implementation (page headers, entry structures, namespace hashing, CRC32)
                    </div>
                    <div style="font-size: 15px; color: #1d1d1f; line-height: 1.47; letter-spacing: -0.016em;">
                        <strong>Type Support:</strong> U8, I8, U16, I16, U32, I32, strings, blobs with multi-span entries for large values
                    </div>
                    <div style="font-size: 15px; color: #1d1d1f; line-height: 1.47; letter-spacing: -0.016em;">
                        <strong>Multi-File Flashing:</strong> Automatically flashes firmware (offset 0x0) + NVS partition (offset 0x9000) in sequence
                    </div>
                    <div style="font-size: 15px; color: #1d1d1f; line-height: 1.47; letter-spacing: -0.016em;">
                        <strong>Web Serial API:</strong> Chrome/Edge/Opera only. HTTPS required in production (localhost OK for dev)
                    </div>
                    <div style="font-size: 15px; color: #1d1d1f; line-height: 1.47; letter-spacing: -0.016em;">
                        <strong>localStorage Persistence:</strong> Configuration auto-saves and restores across sessions
                    </div>
                    <div style="font-size: 15px; color: #1d1d1f; line-height: 1.47; letter-spacing: -0.016em;">
                        <strong>Developer Options:</strong> Custom firmware upload, skip chip validation, verbose logging, baud rate selection
                    </div>
                </div>
            </div>

            <div style="padding: 32px 0; border-top: 1px solid rgba(0,0,0,0.08);">
                <p style="font-size: 15px; color: #6e6e73; line-height: 1.47; margin-bottom: 16px; letter-spacing: -0.016em;">
                    Built on <a href="https://espressif.github.io/esptool-js/" target="_blank" style="color: #0071e3; text-decoration: none;">esptool-js</a> by Espressif Systems. Core flash operations use esptool-js directly.
                </p>
                <a href="https://github.com/adam-weber/esp-webflash-toolkit/tree/main/docs/flasher" target="_blank" style="display: inline-flex; align-items: center; color: #0071e3; text-decoration: none; font-size: 15px; font-weight: 500; letter-spacing: -0.016em;">
                    View source code on GitHub
                    <svg width="14" height="14" viewBox="0 0 14 14" style="margin-left: 6px; opacity: 0.7;">
                        <path d="M11.5 1.5v9M11.5 1.5h-9M11.5 1.5L1.5 11.5" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                    </svg>
                </a>
            </div>
        </div>
    </div>

    <!-- App-specific config -->
    <script src="js/projects-config.js"></script>

    <!-- Core libraries from CDN (GitHub Pages) -->
    <script src="https://jctoledo.github.io/active_wing/dist/nvs-generator.js"></script>

    <script type="module">
        // Import modules from CDN
        import { FlasherApp } from 'https://jctoledo.github.io/active_wing/dist/main-app.js';

        // Get projects from global scope (loaded by projects-config.js)
        const projects = window.PROJECTS || {};

        // Initialize the application
        const app = new FlasherApp(projects);
    </script>

    <script src="../shared-nav.js"></script>
    <script src="../docs-scripts.js"></script>
</body>
</html>
