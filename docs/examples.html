<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Examples - ESP WebFlash Toolkit</title>
    <link rel="stylesheet" href="shared-styles.css">
    <script>
        // Apply dark mode immediately to prevent flash
        (function() {
            const savedMode = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedMode === 'dark' || (!savedMode && prefersDark)) {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
    <link rel="stylesheet" href="docs-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
</head>
<body>
    <div id="navbar-container"></div>

    <nav class="sidebar">
        <!-- Sidebar content will be dynamically generated by docs-sidebar.js -->
    </nav>

    <div class="container">
        <div id="examples" class="lesson">
            <h2>Code Examples</h2>
            <p class="lesson-intro">End-to-end workflows for common use cases.</p>

            <h3>WiFi Setup</h3>
            <p>Generate a WiFi configuration partition and flash to ESP32.</p>

            <pre><code class="language-html">&lt;script src="https://jctoledo.github.io/active_wing/dist/nvs-generator.js"&gt;&lt;/script&gt;
&lt;script&gt;
const generator = new NVSGenerator();

const config = {
    wifi: {
        ssid: "MyNetwork",
        password: "SecurePassword123"
    }
};

const binary = generator.generate(config, 0x6000);  // 24KB partition
// Returns: Uint8Array(24576) ready to flash at 0x9000
&lt;/script&gt;</code></pre>

            <h3>IoT Device Configuration</h3>
            <p>Configure a deployed sensor with network credentials, device settings, and TLS certificates.</p>

            <pre><code class="language-javascript">const generator = new NVSGenerator();

// Configure a deployed sensor
const config = {
    network: {
        wifi_ssid: "FieldSite_5G",
        wifi_pass: "deployment2024",
        mqtt_broker: "mqtt.example.com",
        mqtt_port: 8883
    },
    device: {
        id: "SENSOR_A042",
        location: "Building_3_Floor_2",
        sample_rate: 60,        // seconds
        calibration_offset: -2.5,
        debug_enabled: false
    },
    tls: {
        // Certificate as byte array
        ca_cert: new Uint8Array([0x30, 0x82, 0x03, 0x75, /* ... */])
    }
};

const nvsBinary = generator.generate(config, 0x6000);

// Flash it (browser with Web Serial API)
const port = await navigator.serial.requestPort();
const esploader = await connectToESP32(port);

// Flash firmware + config
await esploader.writeFlash({
    fileArray: [
        { data: firmwareBinary, address: 0x10000 },  // app partition
        { data: nvsBinaryString, address: 0x9000 }   // NVS partition
    ],
    flashSize: 'keep'
});</code></pre>

            <h3>Batch Generation</h3>
            <p>Generate unique configuration binaries for multiple devices in Node.js.</p>

            <pre><code class="language-javascript">const fs = require('fs');
const { NVSGenerator } = require('./nvs-generator.js');

const generator = new NVSGenerator();

// Generate configs for 100 devices
const devices = [
    { id: 'DEV001', location: 'Zone_A', offset: -1.2 },
    { id: 'DEV002', location: 'Zone_A', offset: 0.8 },
    // ... 98 more
];

devices.forEach(device => {
    const config = {
        config: {
            device_id: device.id,
            location: device.location,
            cal_offset: device.offset,
            wifi_ssid: "Factory_Network",
            api_endpoint: "https://api.production.example.com"
        }
    };

    const binary = generator.generate(config, 0x6000);
    fs.writeFileSync(`nvs_${device.id}.bin`, Buffer.from(binary));
    console.log(`Generated nvs_${device.id}.bin`);
});</code></pre>

            <h3>Complete Web Flashing</h3>
            <p>Flash firmware and per-device configuration entirely in the browser—no command line tools required.</p>

            <pre><code class="language-javascript">// Complete web-based flashing: firmware + per-device config
// No Python, no command line, just browser + USB

// 1. Load firmware binaries (same for all devices)
const bootloaderResp = await fetch('firmware/bootloader.bin');
const bootloaderBin = await bootloaderResp.arrayBuffer();

const partitionResp = await fetch('firmware/partition-table.bin');
const partitionBin = await partitionResp.arrayBuffer();

const firmwareResp = await fetch('firmware/app.bin');
const firmwareBin = await firmwareResp.arrayBuffer();

// 2. Generate unique config for THIS device
const generator = new NVSGenerator();
const deviceConfig = {
    wifi: {
        ssid: document.getElementById('wifi-ssid').value,
        password: document.getElementById('wifi-password').value
    },
    config: {
        device_id: `DEVICE_${Date.now()}`,
        api_endpoint: "https://api.production.example.com",
        update_interval: 60
    }
};

const nvsBinary = generator.generate(deviceConfig, 0x6000);

// 3. Convert binaries to strings for esptool-js
function arrayBufferToString(buf) {
    const bytes = new Uint8Array(buf);
    let str = '';
    for (let i = 0; i < bytes.length; i++) {
        str += String.fromCharCode(bytes[i]);
    }
    return str;
}

const bootloaderStr = arrayBufferToString(bootloaderBin);
const partitionStr = arrayBufferToString(partitionBin);
const firmwareStr = arrayBufferToString(firmwareBin);
const nvsStr = arrayBufferToString(nvsBinary);

// 4. Connect to ESP32 via Web Serial
const port = await navigator.serial.requestPort({
    filters: [{ usbVendorId: 0x303a }]  // Espressif
});

const transport = new Transport(port);
const esploader = new ESPLoader(transport, 115200);
await esploader.connect();
console.log('Connected to', esploader.chipName);

// 5. Flash everything in one operation
await esploader.writeFlash({
    fileArray: [
        { data: bootloaderStr, address: 0x0 },
        { data: partitionStr,  address: 0x8000 },
        { data: nvsStr,        address: 0x9000 },   // Unique config
        { data: firmwareStr,   address: 0x10000 }
    ],
    flashSize: 'keep',
    flashMode: 'dio',
    flashFreq: '40m',
    compress: true,
    reportProgress: (fileIndex, written, total) => {
        const percent = Math.round((written / total) * 100);
        console.log(`Flashing ${fileIndex}: ${percent}%`);
        updateProgressBar(percent);
    }
});

console.log('Flash complete!');
await esploader.hardReset();

// Device boots with unique WiFi credentials
// Ready for production deployment</code></pre>

            <h3>ESP-IDF Command Line</h3>
            <p>Generate NVS binary in Node.js and flash using esptool.py.</p>

            <pre><code class="language-javascript">// 1. Generate the NVS binary in Node.js
const fs = require('fs');
const { NVSGenerator } = require('./nvs-generator.js');

const generator = new NVSGenerator();
const config = {
    wifi: {
        ssid: "ProductionNetwork",
        password: "secure_pass_2024"
    },
    config: {
        device_id: "ESP32_PROD_042",
        api_endpoint: "https://api.example.com"
    }
};

const binary = generator.generate(config, 0x6000);
fs.writeFileSync('nvs.bin', Buffer.from(binary));

console.log('Generated nvs.bin (24KB)');</code></pre>

            <pre><code class="language-bash"># 2. Flash using esptool.py (command line)
# Flash NVS partition only
esptool.py --chip esp32c3 --port /dev/ttyUSB0 write_flash 0x9000 nvs.bin

# Or flash complete firmware + NVS
esptool.py --chip esp32c3 --port /dev/ttyUSB0 write_flash \
    0x0    bootloader.bin \
    0x8000 partition-table.bin \
    0x9000 nvs.bin \
    0x10000 firmware.bin

# Device boots with config already loaded</code></pre>

            <h3>Read-Update-Write Workflow</h3>
            <p>Read existing configuration from a device, modify specific values, and flash back without touching firmware.</p>

            <pre><code class="language-javascript">// Complete workflow: Read current config, modify it, flash back

// 1. Read current NVS partition from device
const port = await navigator.serial.requestPort();
const esploader = await connectToESP32(port);

console.log('Reading current NVS from device...');
const currentNVS = await esploader.readFlash(0x9000, 0x6000);
console.log('Read 24KB from 0x9000');

// 2. Parse binary back to config object
const generator = new NVSGenerator();
const currentConfig = generator.parse(new Uint8Array(currentNVS));

console.log('Current config:', currentConfig);
// {
//   wifi: { ssid: "OldNetwork", password: "..." },
//   config: { api_endpoint: "https://api.staging.example.com", ... }
// }

// 3. Modify specific values
currentConfig.wifi.ssid = "NewNetwork";
currentConfig.wifi.password = "new_secure_password";
currentConfig.config.api_endpoint = "https://api.production.example.com";

console.log('Updated config:', currentConfig);

// 4. Generate new binary with modified config
const updatedBinary = generator.generate(currentConfig, 0x6000);

// 5. Convert to binary string for esptool-js
let binaryString = '';
for (let i = 0; i < updatedBinary.length; i++) {
    binaryString += String.fromCharCode(updatedBinary[i]);
}

// 6. Flash ONLY the NVS partition (firmware unchanged)
console.log('Flashing updated config...');
await esploader.writeFlash({
    fileArray: [
        { data: binaryString, address: 0x9000 }
    ],
    flashSize: 'keep',
    compress: true
});

console.log('Config updated! Device will reboot.');
// Device reboots, connects to NewNetwork, hits production API
// Firmware binary at 0x10000 completely untouched</code></pre>

            <h3>10-Line Quickstart</h3>
            <p>Generate WiFi config and flash to ESP32—just 10 lines:</p>

            <pre><code class="language-javascript">// 1. Generate the partition
const generator = new NVSGenerator();
const nvsBinary = generator.generate({
    wifi: { ssid: "MyNetwork", password: "SecurePass123" }
}, 0x6000);

// 2. Flash it to device
const port = await navigator.serial.requestPort();
const esploader = await connectToESP32(port);

await esploader.writeFlash({
    fileArray: [{ data: toFlashString(nvsBinary), address: 0x9000 }],
    flashSize: 'keep'
});

console.log(' Flashed! Device reboots with WiFi credentials.');</code></pre>

            <div style="margin-top: 16px; padding: 12px 16px; background: var(--bg-tertiary); border-radius: 8px;">
                <details style="cursor: pointer;">
                    <summary style="font-size: 13px; font-weight: 600; color: var(--text-secondary); user-select: none;">Helper functions (copy these to your project)</summary>
                    <pre style="margin-top: 12px; margin-bottom: 0;"><code class="language-javascript">// Connect to ESP32 via Web Serial
async function connectToESP32(port) {
    await port.open({ baudRate: 115200 });
    const esploader = new ESPLoader(port, { debugLogging: false });
    await esploader.connect();
    return esploader;
}

// Convert Uint8Array to string format for esptool-js
function toFlashString(bytes) {
    return String.fromCharCode(...bytes);
}</code></pre>
                </details>
            </div>

            <div style="margin-top: 24px; padding: 16px 20px; background: rgba(0,122,255,0.08); border: 1px solid rgba(0,122,255,0.2); border-radius: 8px;">
                <p style="margin: 0; font-size: 14px; color: var(--text-primary);"><strong style="color: #007AFF;">What you just did:</strong> Generated a 24KB NVS partition client-side and flashed it to ESP32 at <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; font-size: 13px;">0x9000</code>. The device will now connect to WiFi on boot. No Python, no esptool.py, no command line.</p>
            </div>
        </div>
    </div>

    <script src="shared-nav.js"></script>
    <script src="docs-scripts.js"></script>
    <script src="docs-sidebar.js"></script>
</body>
</html>
