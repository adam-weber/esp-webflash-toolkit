<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 NVS Editor</title>
    <link rel="stylesheet" href="shared-styles.css">
    <style>
        body.dev-panel-open {
            overflow: hidden;
        }

        /* Main layout: 2 columns always */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 48px 80px 48px;
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 48px;
            align-items: start;
        }

        /* Left panel: Controls & Settings */
        .left-panel {
            background: transparent;
            padding: 0;
            position: sticky;
            top: 100px;
        }

        /* Center panel: Configuration Editor */
        .center-panel {
            background: transparent;
            padding: 0;
            width: 100%;
        }

        .center-panel-header {
            text-align: left;
            margin-bottom: 40px;
        }

        .center-panel-content {
            text-align: left;
        }

        /* Status section */
        .status-section {
            margin-top: 40px;
            padding: 24px;
            background: #f5f5f7;
            border-radius: 18px;
        }

        .status-section-title {
            font-size: 13px;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 500;
            margin-bottom: 16px;
        }

        h1 {
            font-size: 40px;
            color: #1d1d1f;
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: -0.015em;
        }

        .subtitle {
            font-size: 19px;
            color: #6e6e73;
            margin-bottom: 0;
            font-weight: 400;
            letter-spacing: 0.011em;
        }

        h2 {
            font-size: 32px;
            color: #1d1d1f;
            margin-top: 56px;
            margin-bottom: 24px;
            font-weight: 600;
            letter-spacing: -0.012em;
        }

        h2:first-of-type {
            margin-top: 0;
        }

        /* Panel headers with step badges */
        .panel-header {
            font-size: 28px;
            color: #1d1d1f;
            margin-top: 0;
            margin-bottom: 40px;
            font-weight: 600;
            letter-spacing: -0.012em;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .step-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #1d1d1f;
            color: white;
            border-radius: 50%;
            font-size: 15px;
            font-weight: 600;
            flex-shrink: 0;
        }

        h3 {
            font-size: 12px;
            color: #86868b;
            margin-bottom: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        /* Form styling */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .config-group .form-group {
            margin-bottom: 16px;
        }

        .config-group .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 17px;
            font-weight: 400;
            color: #1d1d1f;
            margin-bottom: 10px;
            letter-spacing: -0.022em;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.12);
            border-radius: 8px;
            font-size: 17px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: #ffffff;
            color: #1d1d1f;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #0071e3;
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
        }

        input[type="text"]:invalid:not(:placeholder-shown),
        input[type="password"]:invalid:not(:placeholder-shown),
        input[type="number"]:invalid:not(:placeholder-shown) {
            border-color: #ff3b30;
        }

        input[type="text"]:invalid:focus:not(:placeholder-shown),
        input[type="password"]:invalid:focus:not(:placeholder-shown),
        input[type="number"]:invalid:focus:not(:placeholder-shown) {
            box-shadow: 0 0 0 4px rgba(255, 59, 48, 0.1);
        }

        input::placeholder {
            color: #86868b;
        }

        .help-text {
            font-size: 14px;
            color: #86868b;
            margin-top: 6px;
            display: block;
            line-height: 1.47059;
            letter-spacing: -0.016em;
        }

        .config-group {
            margin-bottom: 48px;
            padding: 32px;
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .config-group:last-child {
            margin-bottom: 0;
        }

        .config-group h3 {
            margin: 0 0 24px 0;
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .config-group .help-text {
            margin-bottom: 24px;
            color: #86868b;
            font-size: 14px;
            text-transform: none;
            letter-spacing: -0.016em;
            font-weight: 400;
        }

        /* Sections */
        .section {
            margin-bottom: 24px;
            background: transparent;
            border-radius: 0;
            padding: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .section:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .section.section-bg {
            background: #ffffff;
            padding: 32px;
            border-radius: 16px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .section h3 {
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            margin-bottom: 20px;
            margin-top: 0;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .instruction-list {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        .instruction-list li {
            font-size: 17px;
            color: #1d1d1f;
            line-height: 1.47059;
            padding: 12px 0;
            padding-left: 36px;
            position: relative;
            letter-spacing: -0.022em;
        }

        .instruction-list li::before {
            content: attr(data-step);
            position: absolute;
            left: 0;
            width: 24px;
            height: 24px;
            background: transparent;
            color: #0071e3;
            border: 2px solid #0071e3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        /* Status box */
        .status-box {
            background: #f5f5f7;
            border: none;
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
            text-align: left;
            transition: all 0.3s cubic-bezier(0.28, 0.11, 0.32, 1);
        }

        .status-box.waiting {
            background: #f5f5f7;
        }

        .status-box.connected {
            background: rgba(0, 113, 227, 0.08);
            border: 1px solid rgba(0, 113, 227, 0.2);
        }

        .status-box.reading {
            background: rgba(255, 149, 0, 0.08);
            border: 1px solid rgba(255, 149, 0, 0.2);
        }

        .status-box.error {
            background: rgba(255, 59, 48, 0.08);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        .status-box.success {
            background: rgba(52, 199, 89, 0.08);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .status-text {
            font-size: 17px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 6px;
            letter-spacing: -0.022em;
        }

        .status-subtext {
            font-size: 15px;
            color: #86868b;
            line-height: 1.47059;
            letter-spacing: -0.016em;
        }

        /* Chip info box */
        .chip-info {
            background: #f5f5f7;
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
            display: none;
        }

        .chip-info.active {
            display: block;
        }

        .chip-info-row {
            display: flex;
            justify-content: space-between;
            font-size: 15px;
            margin-bottom: 10px;
            line-height: 1.47059;
        }

        .chip-info-row:last-child {
            margin-bottom: 0;
        }

        .chip-info-label {
            color: #86868b;
            font-weight: 400;
            letter-spacing: -0.016em;
        }

        .chip-info-value {
            font-weight: 500;
            color: #1d1d1f;
            letter-spacing: -0.016em;
            font-variant-numeric: tabular-nums;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 15px 28px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.28, 0.11, 0.32, 1);
            margin-bottom: 12px;
            letter-spacing: -0.022em;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: #0071e3;
            color: white;
            box-shadow: 0 1px 3px rgba(0, 113, 227, 0.12);
        }

        .btn-primary:hover:not(:disabled) {
            background: #0077ed;
            box-shadow: 0 2px 8px rgba(0, 113, 227, 0.2);
        }

        .btn-success {
            background: #0071e3;
            color: white;
            box-shadow: 0 1px 3px rgba(0, 113, 227, 0.12);
        }

        .btn-success:hover:not(:disabled) {
            background: #0077ed;
            box-shadow: 0 2px 8px rgba(0, 113, 227, 0.2);
        }

        .btn-secondary {
            background: #f5f5f7;
            color: #1d1d1f;
            border: none;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e8e8ed;
        }

        .btn:disabled {
            opacity: 0.32;
            cursor: not-allowed;
        }

        .btn:active:not(:disabled) {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        /* Serial monitor */
        .serial-monitor {
            background: #ffffff;
            color: #1d1d1f;
            border-radius: 0;
            padding: 16px 24px;
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            flex: 1;
            overflow-y: auto;
            line-height: 1.6;
            border: none;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .serial-monitor::-webkit-scrollbar {
            width: 8px;
        }

        .serial-monitor::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.02);
        }

        .serial-monitor::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        .serial-monitor::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.15);
        }

        .serial-line {
            margin-bottom: 4px;
            font-variant-numeric: tabular-nums;
        }

        .serial-line.info {
            color: #4fc3f7;
        }

        .serial-line.success {
            color: #34c759;
        }

        .serial-line.error {
            color: #ff3b30;
        }

        .serial-line.warning {
            color: #ff9500;
        }

        .dev-console-toolbar {
            padding: 12px 24px;
            background: #ffffff;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .dev-console-toolbar .btn {
            font-size: 13px;
            padding: 8px 16px;
            margin: 0;
        }

        /* Developer Options Side Panel */
        .dev-panel-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1400;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.28, 0.11, 0.32, 1);
        }

        .dev-panel-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        .dev-options-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 800px;
            max-width: 90vw;
            background: #ffffff;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
            z-index: 1500;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.28, 0.11, 0.32, 1);
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(0, 0, 0, 0.1);
        }

        .dev-options-panel.active {
            transform: translateX(0);
        }

        .dev-options-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            background: #ffffff;
        }

        .dev-options-title {
            font-size: 20px;
            font-weight: 600;
            color: #1d1d1f;
            letter-spacing: -0.012em;
            margin: 0;
        }

        .dev-options-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .dev-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f5f5f7;
            border: none;
            color: #1d1d1f;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.28, 0.11, 0.32, 1);
        }

        .dev-action-btn:hover {
            background: #e8e8ed;
        }

        .dev-action-btn:active {
            transform: scale(0.9);
        }

        .dev-options-body {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }

        .dev-tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .dev-tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .dev-tab-content[data-tab="console"] {
            padding: 0;
            background: #ffffff;
        }

        /* Responsive */
        @media (max-width: 1000px) {
            .navbar {
                padding: 16px 24px;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 32px;
                padding: 32px 24px 60px 24px;
            }

            .left-panel {
                position: static;
            }

            h1 {
                font-size: 32px;
            }
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 28px;
            }

            .subtitle {
                font-size: 17px;
            }
        }

        /* Key info styling */
        .key-info {
            font-size: 13px;
            color: #86868b;
            font-family: 'SF Mono', Monaco, monospace;
            font-weight: 400;
            margin-left: 8px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #86868b;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 17px;
            margin-bottom: 8px;
            color: #1d1d1f;
            font-weight: 500;
        }

        .empty-state-subtext {
            font-size: 15px;
            color: #86868b;
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>

    <div class="main-content" id="main-content">
        <!-- Left Panel: Device Info & Controls -->
        <div class="left-panel">
            <div class="section section-bg">
                <h3>Connection</h3>
                <button class="btn btn-primary" id="btn-connect">Connect to Device</button>
                <div class="chip-info active" id="chip-info-section" style="display: none; margin-top: 16px;">
                    <div class="chip-info-row">
                        <span class="chip-info-label">Chip Type</span>
                        <span class="chip-info-value" id="chip-type">-</span>
                    </div>
                </div>
            </div>

            <div class="section" style="margin-top: 24px;" id="actions-section">
                <button class="btn btn-primary" id="btn-read" disabled>Read from Device</button>
                <button class="btn btn-success" id="btn-write" disabled style="display: none;">Write to Device</button>
                <button class="btn btn-secondary" id="btn-console-toggle">Console</button>
            </div>

            <!-- Partition Settings -->
            <div class="section" style="margin-top: 32px;">
                <div style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 12px 0;" id="advanced-toggle">
                    <span style="font-size: 13px; color: #86868b; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600;">Partition Settings</span>
                    <span style="font-size: 13px; color: #0071e3;">▼</span>
                </div>
                <div id="advanced-settings" style="display: none; padding-top: 16px;">
                    <div class="form-group">
                        <label for="namespace-input">
                            Namespace
                            <span class="key-info">nvs_get_str()</span>
                        </label>
                        <input type="text" id="namespace-input" value="config" placeholder="config">
                        <span class="help-text">Key-value namespace in NVS partition</span>
                    </div>
                    <div class="form-group">
                        <label for="offset-input">
                            Flash Offset
                            <span class="key-info">36KB</span>
                        </label>
                        <input type="text" id="offset-input" value="0x9000" placeholder="0x9000">
                        <span class="help-text">Start address in SPI flash memory</span>
                    </div>
                    <div class="form-group">
                        <label for="size-input">
                            Partition Size
                            <span class="key-info">24KB</span>
                        </label>
                        <input type="text" id="size-input" value="0x6000" placeholder="0x6000">
                        <span class="help-text">Total NVS partition size (3 pages × 4KB sectors)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Panel: Configuration Editor -->
        <div class="center-panel">
            <div class="center-panel-header">
                <h1>NVS Editor</h1>
                <p class="subtitle">Read and write ESP32 configuration</p>
            </div>

            <!-- Browser compatibility check -->
            <div class="status-box error" id="browser-check" style="display: none; margin-bottom: 24px;">
                <div class="status-text">Browser not supported</div>
                <div class="status-subtext">Please use Chrome, Edge, or Opera</div>
            </div>

            <div id="config-section">
                <div id="config-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <div class="empty-state-text">No configuration loaded</div>
                        <div class="empty-state-subtext">Connect device and click "Read from Device"</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Console Panel (side drawer) -->
    <div class="dev-panel-backdrop" id="console-backdrop"></div>
    <div class="dev-options-panel" id="console-panel">
        <div class="dev-options-header">
            <h2 class="dev-options-title">Console</h2>
            <div class="dev-options-actions">
                <button class="dev-action-btn" id="console-close" aria-label="Close" title="Close">×</button>
            </div>
        </div>
        <div class="dev-options-body">
            <div class="dev-tab-content active" data-tab="console">
                <div class="serial-monitor" id="serial-monitor">
                    <div class="serial-line info">NVS Editor ready. Connect your device to begin.</div>
                </div>
                <div class="dev-console-toolbar">
                    <button class="btn btn-secondary" id="btn-clear-monitor">Clear Console</button>
                </div>
            </div>
        </div>
    </div>

    <script src="./flasher/js/nvs-generator.js"></script>
    <script>
        class NVSEditor {
            constructor() {
                this.transport = null;
                this.espStub = null;
                this.isConnected = false;
                this.configData = {};

                this.btnConnect = document.getElementById('btn-connect');
                this.btnRead = document.getElementById('btn-read');
                this.btnWrite = document.getElementById('btn-write');
                this.chipType = document.getElementById('chip-type');
                this.chipInfoSection = document.getElementById('chip-info-section');
                this.configContainer = document.getElementById('config-container');
                this.namespaceInput = document.getElementById('namespace-input');
                this.offsetInput = document.getElementById('offset-input');
                this.sizeInput = document.getElementById('size-input');
                this.advancedToggle = document.getElementById('advanced-toggle');
                this.advancedSettings = document.getElementById('advanced-settings');
                this.serialMonitor = document.getElementById('serial-monitor');
                this.consoleBackdrop = document.getElementById('console-backdrop');
                this.consolePanel = document.getElementById('console-panel');
                this.btnClearMonitor = document.getElementById('btn-clear-monitor');
                this.btnConsoleClose = document.getElementById('console-close');
                this.btnConsoleToggle = document.getElementById('btn-console-toggle');

                this.attachEventListeners();
                this.checkBrowserSupport();
            }

            attachEventListeners() {
                this.btnConnect.addEventListener('click', () => this.handleConnect());
                this.btnRead.addEventListener('click', () => this.handleRead());
                this.btnWrite.addEventListener('click', () => this.handleWrite());
                this.btnClearMonitor.addEventListener('click', () => this.clearLog());
                this.btnConsoleClose.addEventListener('click', () => this.hideConsole());
                this.btnConsoleToggle.addEventListener('click', () => this.toggleConsole());
                this.advancedToggle.addEventListener('click', () => this.toggleAdvanced());
                this.consoleBackdrop.addEventListener('click', () => this.hideConsole());

                // Update human-readable sizes on input change
                this.offsetInput.addEventListener('input', (e) => this.updateOffsetLabel(e.target.value));
                this.sizeInput.addEventListener('input', (e) => this.updateSizeLabel(e.target.value));
            }

            updateOffsetLabel(hexValue) {
                try {
                    const bytes = parseInt(hexValue, 16);
                    const kb = (bytes / 1024).toFixed(0);
                    const label = this.offsetInput.previousElementSibling;
                    const badge = label.querySelector('.key-info');
                    if (badge && !isNaN(bytes)) {
                        badge.textContent = `${kb}KB`;
                    }
                } catch (e) {
                    // Invalid hex, ignore
                }
            }

            updateSizeLabel(hexValue) {
                try {
                    const bytes = parseInt(hexValue, 16);
                    const kb = (bytes / 1024).toFixed(0);
                    const label = this.sizeInput.previousElementSibling;
                    const badge = label.querySelector('.key-info');
                    if (badge && !isNaN(bytes)) {
                        badge.textContent = `${kb}KB`;
                    }
                } catch (e) {
                    // Invalid hex, ignore
                }
            }

            toggleAdvanced() {
                const isOpen = this.advancedSettings.style.display !== 'none';
                this.advancedSettings.style.display = isOpen ? 'none' : 'block';
                this.advancedToggle.querySelector('span:last-child').textContent = isOpen ? '▼' : '▲';
            }

            checkBrowserSupport() {
                if (!('serial' in navigator)) {
                    document.getElementById('browser-check').style.display = 'block';
                    this.btnConnect.disabled = true;
                    this.log('Web Serial API not supported. Use Chrome, Edge, or Opera.', 'error');
                }
            }

            toggleConsole() {
                if (this.consolePanel.classList.contains('active')) {
                    this.hideConsole();
                } else {
                    this.showConsole();
                }
            }

            showConsole() {
                this.consoleBackdrop.classList.add('active');
                this.consolePanel.classList.add('active');
                document.body.classList.add('dev-panel-open');
                this.btnConsoleToggle.textContent = 'Hide Console';
            }

            hideConsole() {
                this.consoleBackdrop.classList.remove('active');
                this.consolePanel.classList.remove('active');
                document.body.classList.remove('dev-panel-open');
                this.btnConsoleToggle.textContent = 'Show Console';
            }

            log(message, type = 'info') {
                const line = document.createElement('div');
                line.className = `serial-line ${type}`;
                const timestamp = new Date().toLocaleTimeString();
                line.textContent = `[${timestamp}] ${message}`;
                this.serialMonitor.appendChild(line);
                this.serialMonitor.scrollTop = this.serialMonitor.scrollHeight;
            }

            clearLog() {
                this.serialMonitor.innerHTML = '';
            }

            updateStatus(text, subtext, type = 'waiting') {
                // Just log to console - no status box anymore
                this.log(`${text}: ${subtext}`, type === 'error' ? 'error' : type === 'success' ? 'success' : 'info');
            }

            async handleConnect() {
                if (!('serial' in navigator)) {
                    this.updateStatus('Browser not supported', 'Please use Chrome, Edge, or Opera', 'error');
                    return;
                }

                try {
                    this.btnConnect.disabled = true;
                    this.btnConnect.textContent = 'Connecting...';
                    this.updateStatus('Connecting...', 'Select your device in the browser dialog', 'waiting');
                    this.log('Requesting serial port...', 'info');

                    const port = await navigator.serial.requestPort();
                    this.log('Opening serial port...', 'info');

                    const { Transport, ESPLoader } = await import('https://unpkg.com/esptool-js@0.4.5/bundle.js');
                    this.transport = new Transport(port, true);

                    this.espStub = new ESPLoader({
                        transport: this.transport,
                        baudrate: 115200,
                        terminal: {
                            clean: () => {},
                            writeLine: (data) => this.log(data, 'info'),
                            write: (data) => this.log(data, 'info')
                        }
                    });

                    const chipType = await this.espStub.main();
                    this.log(`Connected to ${chipType}`, 'success');

                    let macAddr = 'Unknown';
                    if (this.espStub.chip && this.espStub.chip.macAddr) {
                        macAddr = this.espStub.chip.macAddr();
                        this.log(`MAC Address: ${macAddr}`, 'info');
                    }

                    this.isConnected = true;
                    this.chipType.textContent = chipType;

                    // Show chip info and enable read button
                    this.chipInfoSection.style.display = 'block';
                    this.btnConnect.textContent = 'Connected';
                    this.btnConnect.disabled = true;
                    this.btnRead.disabled = false;

                    // Auto-discover NVS partition
                    await this.discoverNVSPartition();

                } catch (error) {
                    this.log(`Connection failed: ${error.message}`, 'error');
                    this.updateStatus('Connection failed', error.message, 'error');
                    this.btnConnect.disabled = false;
                    this.btnConnect.textContent = 'Connect to Device';
                }
            }

            async discoverNVSPartition() {
                try {
                    this.log('Scanning partition table...', 'info');

                    // Read partition table at 0x8000 (default location)
                    const partitionTableOffset = 0x8000;
                    const partitionTableSize = 0xC00; // 3KB should cover most partition tables

                    const data = await this.espStub.readFlash(partitionTableOffset, partitionTableSize);
                    const buffer = data instanceof ArrayBuffer ? data : data.buffer;
                    const view = new DataView(buffer);

                    const nvsPartitions = [];

                    // Scan for all NVS partitions
                    for (let i = 0; i < partitionTableSize; i += 32) {
                        const magic = view.getUint16(i, true);
                        if (magic !== 0x50AA) continue;

                        const type = view.getUint8(i + 2);
                        const subtype = view.getUint8(i + 3);

                        // Type 1 = data, Subtype 2 = nvs
                        if (type === 0x01 && subtype === 0x02) {
                            const offset = view.getUint32(i + 4, true);
                            const size = view.getUint32(i + 8, true);

                            // Read label (16 bytes, null-terminated)
                            const labelBytes = new Uint8Array(buffer, i + 12, 16);
                            const nullIndex = labelBytes.indexOf(0);
                            const label = new TextDecoder().decode(labelBytes.slice(0, nullIndex > 0 ? nullIndex : 16));

                            nvsPartitions.push({ label, offset, size });
                        }
                    }

                    if (nvsPartitions.length === 0) {
                        this.log('⚠ No NVS partitions found in partition table', 'warning');
                        this.log('Using default values: 0x9000 offset, 0x6000 size', 'info');
                        return;
                    }

                    // Use first NVS partition by default
                    const nvs = nvsPartitions[0];
                    this.log(`✓ Found ${nvsPartitions.length} NVS partition${nvsPartitions.length > 1 ? 's' : ''}`, 'success');
                    this.log(`  Using "${nvs.label}" at 0x${nvs.offset.toString(16)} (${(nvs.size/1024).toFixed(1)}KB)`, 'info');

                    // Update input fields
                    this.offsetInput.value = '0x' + nvs.offset.toString(16);
                    this.sizeInput.value = '0x' + nvs.size.toString(16);

                    // Update human-readable labels
                    this.updateOffsetLabel(this.offsetInput.value);
                    this.updateSizeLabel(this.sizeInput.value);

                    // Set namespace from label if not "nvs"
                    if (nvs.label && nvs.label !== 'nvs') {
                        this.namespaceInput.value = nvs.label;
                    }

                    // Log other partitions if any
                    if (nvsPartitions.length > 1) {
                        nvsPartitions.slice(1).forEach(p => {
                            this.log(`  Also found: "${p.label}" at 0x${p.offset.toString(16)}`, 'info');
                        });
                    }

                } catch (error) {
                    this.log(`⚠ Partition scan failed: ${error.message}`, 'warning');
                    this.log('Using default values: 0x9000 offset, 0x6000 size', 'info');
                }
            }

            async handleRead() {
                if (!this.isConnected) return;

                try {
                    this.btnRead.disabled = true;
                    this.btnRead.textContent = 'Reading...';
                    this.updateStatus('Reading...', 'Fetching NVS partition from device', 'reading');

                    // Get values from inputs (with defaults)
                    const offset = this.offsetInput.value || '0x9000';
                    const size = this.sizeInput.value || '0x6000';
                    const namespace = this.namespaceInput.value || 'config';

                    const offsetInt = parseInt(offset, 16);
                    const sizeInt = parseInt(size, 16);

                    this.log(`Reading ${sizeInt} bytes from 0x${offsetInt.toString(16)}...`, 'info');

                    const flashData = await this.espStub.readFlash(offsetInt, sizeInt);
                    const nvsData = new Uint8Array(flashData);

                    this.log('Parsing NVS data...', 'info');
                    const parsedData = parseNVSConfig(nvsData, namespace);

                    if (Object.keys(parsedData).length === 0) {
                        this.log(`No configuration found in namespace: ${namespace}`, 'warning');
                        this.updateStatus('No data found', 'Partition may be empty or invalid', 'warning');
                        this.showEmptyState();
                    } else {
                        this.configData = parsedData;
                        this.log(`✓ Loaded ${Object.keys(parsedData).length} configuration entries`, 'success');
                        this.renderConfig();
                        this.btnWrite.style.display = 'inline-block';
                        this.btnWrite.disabled = false;
                    }

                    this.btnRead.disabled = false;
                    this.btnRead.textContent = 'Read from Device';

                } catch (error) {
                    this.log(`Read failed: ${error.message}`, 'error');
                    this.updateStatus('Read failed', error.message, 'error');
                    this.btnRead.disabled = false;
                    this.btnRead.textContent = 'Read from Device';
                }
            }

            renderConfig() {
                this.log(`Rendering ${Object.keys(this.configData).length} config entries`, 'info');

                // Create header
                const headerDiv = document.createElement('div');
                headerDiv.style.marginBottom = '32px';

                const title = document.createElement('h2');
                title.textContent = 'Configuration';
                title.style.marginTop = '0';
                title.style.marginBottom = '8px';

                const subtitle = document.createElement('p');
                subtitle.className = 'help-text';
                subtitle.textContent = `${Object.keys(this.configData).length} entries loaded from NVS partition`;
                subtitle.style.marginTop = '0';

                headerDiv.appendChild(title);
                headerDiv.appendChild(subtitle);

                // Create config group
                const configGroup = document.createElement('div');
                configGroup.className = 'config-group';

                Object.entries(this.configData).sort().forEach(([key, value]) => {
                    const formGroup = document.createElement('div');
                    formGroup.className = 'form-group';

                    const label = document.createElement('label');
                    label.innerHTML = `
                        ${key}
                        <span class="key-info">${typeof value} · ${String(value).length} chars</span>
                    `;

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `nvs-${key}`;
                    input.value = value;
                    input.addEventListener('input', (e) => {
                        this.configData[key] = e.target.value;
                    });

                    formGroup.appendChild(label);
                    formGroup.appendChild(input);
                    configGroup.appendChild(formGroup);
                });

                this.configContainer.innerHTML = '';
                this.configContainer.appendChild(headerDiv);
                this.configContainer.appendChild(configGroup);
            }

            showEmptyState() {
                this.configContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <div class="empty-state-text">No configuration found</div>
                        <div class="empty-state-subtext">Try a different namespace or check partition offset/size</div>
                    </div>
                `;
            }

            async handleWrite() {
                if (!this.isConnected) return;

                const confirmed = confirm('Write configuration to device? This will overwrite the NVS partition.');
                if (!confirmed) {
                    this.log('Write cancelled by user', 'warning');
                    return;
                }

                try {
                    this.btnWrite.disabled = true;
                    this.btnWrite.textContent = 'Writing...';
                    this.updateStatus('Writing...', 'Generating and writing NVS partition', 'reading');

                    // Get values from inputs (with defaults)
                    const offset = this.offsetInput.value || '0x9000';
                    const size = this.sizeInput.value || '0x6000';
                    const namespace = this.namespaceInput.value || 'config';

                    const offsetInt = parseInt(offset, 16);
                    const sizeInt = parseInt(size, 16);

                    // Generate NVS partition
                    this.log('Generating NVS partition...', 'info');
                    const nvsData = {};
                    nvsData[namespace] = this.configData;

                    const generator = new NVSGenerator();
                    const nvsBytes = generator.generate(nvsData, sizeInt);

                    // Convert to binary string for esptool
                    let nvsBinary = '';
                    for (let i = 0; i < nvsBytes.length; i++) {
                        nvsBinary += String.fromCharCode(nvsBytes[i]);
                    }

                    this.log(`Writing ${nvsBytes.length} bytes to 0x${offsetInt.toString(16)}...`, 'info');

                    const fileArray = [{ data: nvsBinary, address: offsetInt }];

                    await this.espStub.writeFlash({
                        fileArray: fileArray,
                        flashSize: 'keep',
                        compress: true
                    });

                    this.log(`Wrote ${Object.keys(this.configData).length} entries to device`, 'success');
                    this.updateStatus('Write successful', `${Object.keys(this.configData).length} entries written`, 'success');
                    this.btnWrite.disabled = false;
                    this.btnWrite.textContent = 'Write to Device';

                } catch (error) {
                    this.log(`Write failed: ${error.message}`, 'error');
                    this.updateStatus('Write failed', error.message, 'error');
                    this.btnWrite.disabled = false;
                    this.btnWrite.textContent = 'Write to Device';
                }
            }
        }

        // Initialize the editor
        new NVSEditor();
    </script>

    <script>
        // Load navbar
        fetch('navbar.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('navbar-container').innerHTML = html;
            });
    </script>
</body>
</html>
