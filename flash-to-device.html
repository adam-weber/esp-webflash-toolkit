<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash to Device - ESP WebFlash Toolkit</title>
    <link rel="stylesheet" href="shared-styles.css">
    <script>
        // Apply dark mode immediately to prevent flash
        (function() {
            const savedMode = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedMode === 'dark' || (!savedMode && prefersDark)) {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
    <link rel="stylesheet" href="docs-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
</head>
<body>
    <div id="navbar-container"></div>

    <nav class="sidebar">
        <!-- Sidebar content will be dynamically generated by docs-sidebar.js -->
    </nav>

    <div class="container">
        <div id="flash" class="lesson">
            <h2>Device Flashing Operations</h2>
            <p class="lesson-intro">Generated binaries are written to ESP32 flash memory via Web Serial API integration.</p>

            <h3>NVS Partition Location</h3>

            <div style="background: var(--bg-secondary); border: 1px solid rgba(0,0,0,0.08); border-radius: 12px; padding: 32px 40px; margin: 32px 0;">
                <p style="margin: 0 0 28px 0; font-size: 14px; line-height: 1.6; color: var(--text-primary);">
                    The partition table (partitions.csv) defines NVS partition placement in flash memory. ESP32 flash is divided into fixed-address regions, each serving a specific purpose in the boot and runtime process.
                </p>

                <!-- Flash Memory Layout -->
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 12px; font-weight: 600; color: var(--text-tertiary); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.05em;">ESP32 Flash Memory Layout</div>

                    <!-- Memory Map -->
                    <div style="display: grid; grid-template-columns: 100px 1fr; gap: 0; font-family: 'SF Mono', Monaco, monospace;">
                        <!-- Bootloader -->
                        <div style="padding: 16px 20px; background: var(--bg-tertiary); border: 1px solid rgba(0,0,0,0.08); border-bottom: none; border-top-left-radius: 8px; text-align: right; font-size: 13px; font-weight: 600; color: var(--text-secondary);">
                            0x1000
                        </div>
                        <div style="padding: 16px 20px; background: linear-gradient(135deg, rgba(255,149,0,0.10) 0%, rgba(255,149,0,0.05) 100%); border: 1px solid rgba(255,149,0,0.3); border-left: none; border-bottom: none; border-top-right-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-size: 14px; font-weight: 600; color: #FF9500; margin-bottom: 2px;">bootloader.bin</div>
                                <div style="font-size: 11px; color: var(--text-secondary); font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;">Second-stage bootloader</div>
                            </div>
                            <div style="font-size: 11px; color: var(--text-tertiary);">~28 KB</div>
                        </div>

                        <!-- Partition Table -->
                        <div style="padding: 16px 20px; background: var(--bg-tertiary); border: 1px solid rgba(0,0,0,0.08); border-bottom: none; text-align: right; font-size: 13px; font-weight: 600; color: var(--text-secondary);">
                            0x8000
                        </div>
                        <div style="padding: 16px 20px; background: var(--bg-tertiary); border: 1px solid rgba(0,0,0,0.08); border-left: none; border-bottom: none; display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 2px;">partition-table.bin</div>
                                <div style="font-size: 11px; color: var(--text-secondary); font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;">Partition layout definition</div>
                            </div>
                            <div style="font-size: 11px; color: var(--text-tertiary);">~4 KB</div>
                        </div>

                        <!-- NVS (Highlighted) -->
                        <div style="padding: 16px 20px; background: var(--bg-tertiary); border: 1px solid rgba(0,0,0,0.08); border-bottom: none; text-align: right; font-size: 13px; font-weight: 600; color: var(--text-secondary);">
                            0x9000
                        </div>
                        <div style="padding: 16px 20px; background: linear-gradient(135deg, rgba(0,122,255,0.12) 0%, rgba(0,122,255,0.06) 100%); border: 2px solid rgba(0,122,255,0.4); border-left: none; border-bottom: none; display: flex; align-items: center; justify-content: space-between; position: relative;">
                            <div>
                                <div style="font-size: 14px; font-weight: 600; color: #007AFF; margin-bottom: 2px;">nvs.bin</div>
                                <div style="font-size: 11px; color: var(--text-secondary); font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;">Non-Volatile Storage partition</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="font-size: 11px; color: var(--text-tertiary);">~24 KB</div>
                                <div style="padding: 4px 10px; background: #007AFF; color: white; border-radius: 6px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;">Target</div>
                            </div>
                        </div>

                        <!-- Application -->
                        <div style="padding: 16px 20px; background: var(--bg-tertiary); border: 1px solid rgba(0,0,0,0.08); border-bottom-left-radius: 8px; text-align: right; font-size: 13px; font-weight: 600; color: var(--text-secondary);">
                            0x10000
                        </div>
                        <div style="padding: 16px 20px; background: linear-gradient(135deg, rgba(52,199,89,0.10) 0%, rgba(52,199,89,0.05) 100%); border: 1px solid rgba(52,199,89,0.3); border-left: none; border-bottom-right-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-size: 14px; font-weight: 600; color: #34C759; margin-bottom: 2px;">app.bin</div>
                                <div style="font-size: 11px; color: var(--text-secondary); font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;">Main application firmware</div>
                            </div>
                            <div style="font-size: 11px; color: var(--text-tertiary);">Variable</div>
                        </div>
                    </div>
                </div>

                <!-- Important Note -->
                <div style="padding: 16px 20px; background: rgba(255,149,0,0.06); border: 1px solid rgba(255,149,0,0.15); border-radius: 8px;">
                    <div style="font-size: 13px; color: var(--text-primary); line-height: 1.7;">
                        <strong style="color: #FF9500;">Note:</strong> The 0x9000 address for NVS is conventional but not mandatory. Partition tables may locate NVS at any address. Flash operations must target the address specified in the partition table, not hardcoded values.
                    </div>
                </div>
            </div>

            <h3>Automatic Partition Detection</h3>
            <p>When firmware is already flashed, the toolkit can automatically detect the NVS partition offset and size by reading the partition table from flash memory. This eliminates the need to manually look up addresses in partitions.csv.</p>

            <pre><code class="language-javascript">// Auto-detect NVS partition from flashed firmware
const partitionInfo = await detectNVSPartition(espLoader);
// Returns: { offset: 0x9000, size: 0x6000, label: "nvs" }

// Generate NVS binary with detected size
const nvsBinary = generator.generate(config, partitionInfo.size);

// Convert to string format for esptool-js
let nvsString = '';
for (let i = 0; i < nvsBinary.length; i++) {
    nvsString += String.fromCharCode(nvsBinary[i]);
}

// Flash to detected offset
await espLoader.writeFlash({
    fileArray: [{ data: nvsString, address: partitionInfo.offset }],
    flashSize: 'keep',
    compress: true
});</code></pre>

            <div class="callout">
                <div class="callout-title">Automatic Detection Benefits</div>
                <div class="callout-body">
                    <strong>Simplified Workflow:</strong> Connect device → Detect partition → Flash config — no partition table lookup required
                    <br><strong>Error Prevention:</strong> Eliminates incorrect offset errors that can brick devices
                    <br><strong>Multi-Device Support:</strong> Works across different partition layouts without code changes
                    <br><br>
                    <strong>Fallback:</strong> If detection fails (blank chip, custom partition table), specify offset manually from your partitions.csv file.
                </div>
            </div>

            <h3>Web Serial Integration</h3>
            <p>Chrome's Web Serial API provides USB serial port access. esptool-js implements the ESP32 ROM bootloader protocol in JavaScript. Combined, these enable browser-based flash operations.</p>

            <pre><code class="language-javascript">// Manual offset specification (when auto-detection unavailable)
const nvsBinary = generator.generate(config, 0x6000);

// esptool-js requires binary string format, not Uint8Array
let nvsString = '';
for (let i = 0; i < nvsBinary.length; i++) {
    nvsString += String.fromCharCode(nvsBinary[i]);
}

await espLoader.writeFlash({
    fileArray: [
        { data: firmwareBinary, address: 0x10000 },
        { data: nvsString, address: 0x9000 }
    ],
    flashSize: 'keep',
    compress: true
});</code></pre>

            <h3>Browser Compatibility Requirements</h3>
            <p>Web Serial API availability is limited to Chromium-based browsers: Chrome 89+, Edge 89+, Opera 75+. Firefox, Safari, and mobile browsers lack Web Serial support. Desktop Chrome or equivalent Chromium browser is required.</p>

            <p>USB port access requires explicit user permission per session. Permission requests must originate from user gestures (button clicks):</p>

            <pre><code class="language-javascript">button.onclick = async () => {
    const port = await navigator.serial.requestPort({
        filters: [{ usbVendorId: 0x303a }]  // Espressif vendor ID
    });
};</code></pre>
        </div>

        <!-- Read -->
    </div>

    <script src="shared-nav.js"></script>
    <script src="docs-scripts.js"></script>
    <script src="docs-sidebar.js"></script>
</body>
</html>
